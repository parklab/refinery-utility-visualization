var rfnry = { vis: { util: (function() {function genericPlain(a,b,c){var d=b.width,e=b.height,f=b.globalMax,g="vertical"===b.orientation?!0:!1,h=g?.01*d:.01*e,i=e/a.length-h,j=d3.scale.linear().domain([0,f]).range([0,d]),k=d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,e],0);g&&(i=d/a.length-h,j=d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,d],0),k=d3.scale.linear().domain([0,f]).range([e,0])),d3.select(b.drawTarget).selectAll("rect").data(a).enter().append("rect").attr("class","bar").attr("x",function(a){return g?j(a.id):0}).attr("y",function(a){return k(g?a.value:a.id)}).attr("width",function(a){return g?i:j(a.value)}).attr("height",function(a){return g?e-k(a.value):i}).style("fill",function(a){return b.color(a.id)}).on("mousemove",function(a){c.onMouseMove(a,this,c)}).on("mouseover",function(a){c.onMouseOver(a,this,c)}).on("mouseout",function(a){c.onMouseOut(a,this,c)}).on("click",function(a){c.onClick(a,this,c)})}function genericSVGFormat(a){var b=a.width,c=a.height,d=a.drawTarget,e=a.hLeft||.1,f=a.hMid||.8,g=a.hRight||.1,h=a.vTop||.1,i=a.vMid||.8,j=a.vBot||.1,k=1e-4;(Math.abs(e+f+g-1)>k||Math.abs(h+i+j-1)>k)&&console.err("FormatError: partition percentages exceed or do not add up to 1"),d3.select("#"+d).html("");var l=d3.select("#"+d).append("svg").attr("width",b).attr("height",c),m=b*e,n=b*(e+f),o=c*h,p=c*(h+i),q=l.selectAll(".leftTop").data([1]).enter().append("g").attr("width",b*e).attr("height",c*h).attr("transform","translate(0, 0)"),r=l.selectAll(".leftMid").data([1]).enter().append("g").attr("width",b*e).attr("height",c*i).attr("transform","translate(0, "+o+")"),s=l.selectAll(".leftBot").data([1]).enter().append("g").attr("width",b*e).attr("height",c*j).attr("transform","translate(0, "+p+")"),t=l.selectAll(".midTop").data([1]).enter().append("g").attr("width",b*f).attr("height",c*h).attr("transform","translate("+m+", 0)"),u=l.selectAll(".midMid").data([1]).enter().append("g").attr("width",b*f).attr("height",c*i).attr("transform","translate("+m+", "+o+")"),v=l.selectAll(".midBot").data([1]).enter().append("g").attr("width",b*f).attr("height",c*j).attr("transform","translate("+m+", "+p+")"),w=l.selectAll(".rightTop").data([1]).enter().append("g").attr("width",b*g).attr("height",c*h).attr("transform","translate("+n+", 0)"),x=l.selectAll(".rightMid").data([1]).enter().append("g").attr("width",b*g).attr("height",c*i).attr("transform","translate("+n+", "+o+")"),y=l.selectAll(".rightBot").data([1]).enter().append("g").attr("width",b*g).attr("height",c*j).attr("transform","translate("+n+", "+p+")");return[[q,r,s],[t,u,v],[w,x,y]]}function genericAxis(a){var b=a.orientation,c=a.drawTarget,d=a.scale,e=a.xShift||0,f=a.yShift||0,g=a.tickAmt||5,h=void 0===a.tickSize?6:a.tickSize,i=a.axisClass||"refinery-utility-axis",j=a.blank||!1;j&&(i="refinery-utility-blankaxis");var k=d3.svg.axis().scale(d).orient(b).ticks(g).tickSize(h);d3.select(c).selectAll("axis").data([1]).enter().append("g").attr("class",i).attr("transform","translate("+e+", "+f+")").style("fill","none").style("stroke",j?"none":"black").call(k)}function simplePlain(a,b,c){for(var d="vertical"===b.orientation?!0:!1,e=.1,f=.8,g=.8,h=genericSVGFormat({width:b.width,height:b.height,drawTarget:b.drawTarget}),i=b.width*f,j=b.height*g,k=[],l=0;l<a.items.length;l++)k.push({id:a.items[l],value:a.matrix[l].sum()});var m=k.map(function(a){return a.value}).max(),n=i,o=j;genericPlain(k,{globalMax:m,orientation:b.orientation,width:i,height:j,drawTarget:h[1][1][0][0],color:d3.scale.category10().domain(k.map(function(a){return a.id}))},c),genericAxis({orientation:"bottom",drawTarget:h[1][2][0][0],tickSize:d?0:6,scale:d?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,n],0):d3.scale.linear().domain([0,m]).range([0,n])}),genericAxis({orientation:"left",drawTarget:h[0][1][0][0],tickSize:d?6:0,scale:d?d3.scale.linear().domain([0,m]).range([o,0]):d3.scale.ordinal().domain(a.items.reverse()).rangeRoundBands([o,0],0),xShift:e*b.width})}function group(a,b,c){for(var d="vertical"===b.orientation?!0:!1,e=.8,f=.8,g=genericSVGFormat({width:b.width,height:b.height,drawTarget:b.drawTarget}),h=b.width*e,i=b.height*f,j=a.matrix.map(function(a){return a.max()}).max(),k=[],l=0;l<a.items.length;l++){for(var m=[],n=0;n<a.matrix[l].length;n++)m.push({id:a.items[l]+"-"+a.categories[n],value:a.matrix[l][n]});k.push(m)}for(var o=d?.01*h:.01*i,p=d?h/k.length-o:h,q=d?i:i/k.length-o,r=d3.select(g[1][1][0][0]).selectAll("g").data(k).enter().append("g").attr("width",p).attr("height",q).attr("transform",function(a,b){return d?"translate("+b*(p+o)+", 0)":"translate(0, "+b*(q+o)+")"}),s=[],l=0;l<r[0].length;l++)s.push({width:p,height:q,orientation:b.orientation,drawTarget:r[0][l],globalMax:j,color:d3.scale.category10().domain(k[l].map(function(a){return a.id}))});for(var l=0;l<k.length;l++)genericPlain(k[l],s[l],c);genericAxis({orientation:"bottom",drawTarget:g[1][2][0][0],scale:d?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,h],0):d3.scale.linear().domain([0,j]).range([0,p]),xShift:0,yShift:0,tickSize:d?0:6}),genericAxis({orientation:"left",drawTarget:g[0][1][0][0],scale:d?d3.scale.linear().domain([0,j]).range([i,0]):d3.scale.ordinal().domain(a.items.reverse()).rangeRoundBands([i,0],0),xShift:.1*b.width,yShift:0,tickSize:d?6:0})}function layer(a,b,c){for(var d="vertical"===b.orientation?!0:!1,e=.1,f=.8,g=.1,h=.1,i=.8,j=.1,k=genericSVGFormat({width:b.width,height:b.height,drawTarget:b.drawTarget,hLeft:e,hMid:f,hRight:g,vTop:h,vMid:i,vBot:j}),l=b.width*f,m=d?b.height*i:b.height*i,n=a.matrix.map(function(a){return a.max()}).max(),o=[],p=0;p<a.categories.length;p++){for(var q=[],r=0;r<a.matrix.length;r++)q.push({id:a.items[r]+"-"+a.categories[p],value:a.matrix[r][p]});o.push(q)}for(var s=d?.05*l:.05*m,t=d?l:l/o.length-s,u=d?m/o.length-s:m,v=d3.select(d?k[1][1][0][0]:k[1][1][0][0]).selectAll("g").data(o).enter().append("g").attr("width",t).attr("height",u).attr("transform",function(a,b){return d?"translate(0, "+b*(u+s)+")":"translate("+b*(t+s)+", 0)"}),w=[],p=0;p<v[0].length;p++)w.push({width:t,height:u,orientation:b.orientation,drawTarget:v[0][p],globalMax:n,color:function(){return d3.scale.category10().range()[p]}});for(var p=0;p<o.length;p++)d?(w[p].color=function(){return d3.scale.category10().range().slice(0,o.length).reverse()[p]},genericPlain(o[o.length-1-p],w[p],c)):genericPlain(o[p],w[p],c);if(d)genericAxis({orientation:"bottom",drawTarget:k[1][2][0][0],scale:d3.scale.ordinal().domain(a.items).rangeRoundBands([0,t],0),yShift:-b.height*j*.55,tickSize:0});else for(var x=d3.select(k[1][2][0][0]).selectAll("g").data(o).enter().append("g").attr("width",t).attr("height",b.height*j).attr("transform",function(a,b){return"translate("+b*(t+s)+", 0)"}),p=0;p<x[0].length;p++)genericAxis({orientation:"bottom",drawTarget:x[0][p],scale:d3.scale.linear().domain([0,n]).range([0,t])});if(d)for(var x=d3.select(k[0][1][0][0]).selectAll("g").data(o).enter().append("g").attr("width",b.width*e).attr("height",u).attr("transform",function(a,b){return"translate(0, "+b*(u+s)+")"}),p=0;p<x[0].length;p++)genericAxis({orientation:"left",drawTarget:x[0][p],scale:d3.scale.linear().domain([0,n]).range([u,0]),xShift:b.width*e,tickAmt:3});else genericAxis({orientation:"left",drawTarget:k[0][1][0][0],scale:d3.scale.ordinal().domain(a.items).rangeRoundBands([0,u],0),xShift:b.width*e,tickSize:0});genericAxis(d?{orientation:"right",drawTarget:k[2][1][0][0],scale:d3.scale.ordinal().domain(a.categories).rangeRoundBands([m,0],0),blank:!0}:{orientation:"bottom",drawTarget:k[1][0][0][0],scale:d3.scale.ordinal().domain(a.categories).rangeRoundBands([0,l],0),blank:!0,xShift:-b.width*e*.2,yShift:b.height*h*.7})}function stack(a,b,c){for(var d="vertical"===b.orientation?!0:!1,e=(a.matrix.map(function(a){return a.max()}).max(),a.matrix.map(function(a){return a.sum()}).max()),f=d3.scale.ordinal().domain(a.categories).range(d3.scale.category10().range()),g=genericSVGFormat({width:b.width,height:b.height,drawTarget:b.drawTarget}),h=.8*b.width,i=.8*b.height,j=[],k=0;k<a.items.length;k++){j.push({}),j[k].item=a.items[k];for(var l=0;l<a.categories.length;l++)j[k][a.categories[l]]=a.matrix[k][l]}j.forEach(d?function(a){var b=0;a.nums=f.domain().map(function(c){return{name:c,y0:b,y1:b+=+a[c]}}),a.total=a.nums[a.nums.length-1].y1}:function(a){var b=0;a.nums=f.domain().map(function(c){return{name:c,x0:b,x1:b+=a[c]}}),a.total=a.nums[a.nums.length-1].x1});var m=d?d3.scale.ordinal().domain(j.map(function(a){return a.item})).rangeRoundBands([0,h],.1):d3.scale.linear().domain([0,d3.max(j,function(a){return a.total})]).range([0,h]),n=d?d3.scale.linear().domain([0,d3.max(j,function(a){return a.total})]).range([i,0]):d3.scale.ordinal().domain(j.map(function(a){return a.item})).rangeRoundBands([0,i],.1);if(d){var o=d3.select(g[1][1][0][0]).selectAll(".item").data(j).enter().append("g").attr("transform",function(a){return"translate("+m(a.item)+", 0)"});o.selectAll("rect").data(function(a){return a.nums}).enter().append("rect").attr("class","bar").attr("y",function(a){return n(a.y1)}).attr("width",m.rangeBand()).attr("height",function(a){return n(a.y0)-n(a.y1)}).style("fill",function(a){return f(a.name)}).on("mousemove",function(a){c.onMouseMove({id:a.name,value:a.y1-a.y0},this,c)}).on("mouseover",function(a){c.onMouseOver({id:a.name,value:a.y1-a.y0},this,c)}).on("mouseout",function(a){c.onMouseOut({id:a.name,value:a.y1-a.y0},this,c)}).on("click",function(a){c.onClick({id:a.name,value:a.y1-a.y0},this,c)})}else{var o=d3.select(g[1][1][0][0]).selectAll(".item").data(j).enter().append("g").attr("transform",function(a){return"translate(0, "+n(a.item)+")"});o.selectAll("rect").data(function(a){return a.nums.reverse()}).enter().append("rect").attr("class","bar").attr("x",function(a){return m(a.x0)}).attr("y",function(a){return n(a.name)}).attr("width",function(a){return m(a.x1)-m(a.x0)}).attr("height",n.rangeBand()).style("fill",function(a){return f(a.name)}).on("mousemove",function(a){c.onMouseMove({id:a.name,value:a.x1-a.x0},this,c)}).on("mouseover",function(a){c.onMouseOver({id:a.name,value:a.x1-a.x0},this,c)}).on("mouseout",function(a){c.onMouseOut({id:a.name,value:a.x1-a.x0},this,c)}).on("click",function(a){c.onClick({id:a.name,value:a.x1-a.x0},this,c)})}genericAxis({orientation:"bottom",drawTarget:g[1][2][0][0],scale:d?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,h],0):d3.scale.linear().domain([0,e]).range([0,h]),tickSize:d?0:6}),genericAxis({orientation:"left",drawTarget:g[0][1][0][0],scale:d?d3.scale.linear().domain([0,e]).range([i,0]):d3.scale.ordinal().domain(a.items).rangeRoundBands([0,i],0),xShift:.1*b.width,tickSize:d?6:0})}function draw(a,b,c){d3.select("#"+c.drawTarget).html("");var d=jQuery.extend(!0,{},b),e=jQuery.extend(!0,{},c),f=jQuery.extend(!0,{},events);"group"===a?group(d,e,f):"layer"===a?layer(d,e,f):"simple"===a?simplePlain(d,e,f):"stack"===a?stack(d,e,f):alert("Invalid chart type"),d3.select("body").selectAll("text").attr("font-family","sans-serif").attr("fill","black").attr("font-size","14px")}Array.prototype.max=function(){for(var a=0,b=this.length;b--;)a<this[b]&&(a=this[b]);return a},Array.prototype.sum=function(){for(var a=0,b=this.length;b--;)a+=this[b];return a};var tooltip=d3.select("body").append("div").attr("class","refinery-utility-tooltip").style("opacity",0).style("position","absolute").style("text-align","center").attr("width","100px").style("background-color","#000").style("opacity","0.8").style("color","#fff").style("font-weight","normal").style("font-size","11.9px").style("border-radius","3px").style("padding","1px 4px 1px 4px"),events={onMouseMove:function(a,b,c){c.tooltipFlag&&c.tooltip.html(a.id+"<br>"+a.value).style("opacity",.9).style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")},onMouseOver:function(a,b,c){c.tooltipFlag=!0,d3.select(b.parentNode).selectAll(".bar").attr("opacity",.6),d3.select(b).attr("opacity",1)},onMouseOut:function(a,b,c){c.tooltipFlag=!1,d3.select(b.parentNode).selectAll(".bar").attr("opacity",1),c.tooltip.style("opacity",0)},onClick:function(){console.log("clicky action going on")},tooltip:tooltip,tooltipFlag:!1},util={draw:draw};        	return util;
        })()
    }
}