/*! refinery-utility-visualization 2014-06-16 */
var rfnry={vis:{util:function(){function a(a){d3.selectAll("#test").remove();var b=d3.select("body").append("svg").attr("id","test").attr("width",0).attr("height",0).selectAll("text").data([1]).enter().append("text").text(a);return b[0][0].getBBox().width}function b(b,c){if(a(b)<=c)return b;for(var d=0;d<b.length/2;d++){var e=b.substring(0,b.length/2-d)+".."+b.substring(b.length/2+d,b.length);if(a(e)<=c)return e}}function c(a,b,c){var d=b.width,e=b.height,f=b.globalMax,g="vertical"===b.orientation?!0:!1,h=b.color||d3.scale.category10().domain(a.map(function(a){return a.id})),i=g?.01*d:.01*e,j=e/a.length-i,k=d3.scale.linear().domain([0,f]).range([0,d]),l=d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,e],0);g&&(j=d/a.length-i,k=d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,d],0),l=d3.scale.linear().domain([0,f]).range([e,0])),d3.select(b.drawTarget).selectAll("rect").data(a).enter().append("rect").attr("class","bar").attr("x",function(a){return g?k(a.id):0}).attr("y",function(a){return l(g?a.value:a.id)}).attr("width",function(a){return g?j:k(a.value)}).attr("height",function(a){return g?e-l(a.value):j}).style("fill",function(a){return h(a.id)}).on("mousemove",function(a){c.onMouseMove(a,this,c)}).on("mouseover",function(a){c.onMouseOver(a,this,c)}).on("mouseout",function(a){c.onMouseOut(a,this,c)}).on("click",function(a){c.onClick(a,this,c)})}function d(a){var b=a.width,c=a.height,d=a.drawTarget,e=a.hLeft||.1,f=a.hMid||.8,g=a.hRight||.1,h=a.vTop||.1,i=a.vMid||.8,j=a.vBot||.1,k=1e-4;(Math.abs(e+f+g-1)>k||Math.abs(h+i+j-1)>k)&&console.err("FormatError: partition percentages exceed or do not add up to 1"),d3.select("#"+d).html("");var l=d3.select("#"+d).append("svg").attr("width",b).attr("height",c),m=b*e,n=b*(e+f),o=c*h,p=c*(h+i),q=l.selectAll(".leftTop").data([1]).enter().append("g").attr("width",b*e).attr("height",c*h).attr("transform","translate(0, 0)"),r=l.selectAll(".leftMid").data([1]).enter().append("g").attr("width",b*e).attr("height",c*i).attr("transform","translate(0, "+o+")"),s=l.selectAll(".leftBot").data([1]).enter().append("g").attr("width",b*e).attr("height",c*j).attr("transform","translate(0, "+p+")"),t=l.selectAll(".midTop").data([1]).enter().append("g").attr("width",b*f).attr("height",c*h).attr("transform","translate("+m+", 0)"),u=l.selectAll(".midMid").data([1]).enter().append("g").attr("width",b*f).attr("height",c*i).attr("transform","translate("+m+", "+o+")"),v=l.selectAll(".midBot").data([1]).enter().append("g").attr("width",b*f).attr("height",c*j).attr("transform","translate("+m+", "+p+")"),w=l.selectAll(".rightTop").data([1]).enter().append("g").attr("width",b*g).attr("height",c*h).attr("transform","translate("+n+", 0)"),x=l.selectAll(".rightMid").data([1]).enter().append("g").attr("width",b*g).attr("height",c*i).attr("transform","translate("+n+", "+o+")"),y=l.selectAll(".rightBot").data([1]).enter().append("g").attr("width",b*g).attr("height",c*j).attr("transform","translate("+n+", "+p+")");return[[q,r,s],[t,u,v],[w,x,y]]}function e(a,c){var d=a.orientation,e=a.drawTarget,f=a.scale,g=a.xShift||0,h=a.yShift||0,i=a.tickAmt||5,j=void 0===a.tickSize?6:a.tickSize,k=a.axisClass||"refinery-utility-axis",l=a.blank||!1;maxLabelSize=a.maxLabelSize||1e3,l&&(k="refinery-utility-blankaxis");var m=d3.svg.axis().scale(f).orient(d).ticks(i).tickSize(j),n=d3.select(e);n.selectAll("axis").data([1]).enter().append("g").attr("class",k).attr("transform","translate("+g+", "+h+")").style("fill","none").style("stroke",l?"none":"black").call(m),n.selectAll("text").text(function(a){return b(a,maxLabelSize)}),n.selectAll(".tick").on("mousemove",function(a){c.onMouseMove(a,this,c)}).on("mouseover",function(a){c.onMouseOver(a,this,c)}).on("mouseout",function(a){c.onMouseOut(a,this,c)}).on("click",function(a){c.onClick(a,this,c)})}function f(a,b,f,g){for(var h="vertical"===b.orientation?!0:!1,i=.1,j=.8,k=.8,l=b.width*j,m=b.height*k,n=d({width:b.width,height:b.height,drawTarget:b.drawTarget}),o=[],p=0;p<a.items.length;p++)o.push({id:a.items[p],value:a.matrix[p].sum()});var q=o.map(function(a){return a.value}).max(),r=l,s=m;c(o,{globalMax:q,orientation:b.orientation,width:l,height:m,drawTarget:n[1][1][0][0],maxLabelSize:b.width*i*.8},f),e({orientation:"bottom",drawTarget:n[1][2][0][0],tickSize:h?0:6,scale:h?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,r],0):d3.scale.linear().domain([0,q]).range([0,r])},g),e({orientation:"left",drawTarget:n[0][1][0][0],tickSize:h?6:0,scale:h?d3.scale.linear().domain([0,q]).range([s,0]):d3.scale.ordinal().domain(a.items.reverse()).rangeRoundBands([s,0],0),xShift:i*b.width},g)}function g(a,b,f,g){function h(a){return a.id}var i=0,j="vertical"===b.orientation?!0:!1,k=.8,l=.8,m=d({width:b.width,height:b.height,drawTarget:b.drawTarget}),n=b.width*k,o=b.height*l,p=a.matrix.map(function(a){return a.max()}).max(),q=[];for(i=0;i<a.items.length;i++){for(var r=[],s=0;s<a.matrix[i].length;s++)r.push({id:a.items[i]+"-"+a.categories[s],value:a.matrix[i][s]});q.push(r)}var t=j?.01*n:.01*o,u=j?n/q.length-t:n,v=j?o:o/q.length-t,w=d3.select(m[1][1][0][0]).selectAll("g").data(q).enter().append("g").attr("width",u).attr("height",v).attr("transform",function(a,b){return j?"translate("+b*(u+t)+", 0)":"translate(0, "+b*(v+t)+")"}),x=[];for(i=0;i<w[0].length;i++)x.push({width:u,height:v,orientation:b.orientation,drawTarget:w[0][i],globalMax:p,color:d3.scale.category10().domain(q[i].map(h))});for(i=0;i<q.length;i++)c(q[i],x[i],f);e({orientation:"bottom",drawTarget:m[1][2][0][0],scale:j?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,n],0):d3.scale.linear().domain([0,p]).range([0,u]),xShift:0,yShift:0,tickSize:j?0:6,maxLabelSize:j?.9*u:1e3},g),e({orientation:"left",drawTarget:m[0][1][0][0],scale:j?d3.scale.linear().domain([0,p]).range([o,0]):d3.scale.ordinal().domain(a.items.reverse()).rangeRoundBands([o,0],0),xShift:.1*b.width,yShift:0,tickSize:j?6:0,maxLabelSize:.1*b.width*.8},g)}function h(a,c,d){function e(){return A[g]}function f(){return A[g]}var g=0,h="vertical"===c.orientation?!0:!1,i=.1,j=.8,k=.1,l=.1,m=.8,o=.1,p=genericSVGFormat({width:c.width,height:c.height,drawTarget:c.drawTarget,hLeft:i,hMid:j,hRight:k,vTop:l,vMid:m,vBot:o}),q=c.width*j,r=h?c.height*m:c.height*m,s=a.matrix.map(function(a){return a.max()}).max(),t=[];for(g=0;g<a.categories.length;g++){for(var u=[],v=0;v<a.matrix.length;v++)u.push({id:a.items[v]+"-"+a.categories[g],value:a.matrix[v][g]});t.push(u)}var w=h?.05*q:.05*r,x=h?q:q/t.length-w,y=h?r/t.length-w:r,z=d3.select(h?p[1][1][0][0]:p[1][1][0][0]).selectAll("g").data(t).enter().append("g").attr("width",x).attr("height",y).attr("transform",function(a,b){return h?"translate(0, "+b*(y+w)+")":"translate("+b*(x+w)+", 0)"}),A=d3.scale.category10().range(),B=[];for(g=0;g<z[0].length;g++)B.push({width:x,height:y,orientation:c.orientation,drawTarget:z[0][g],globalMax:s,color:e});d3.scale.category10().range().slice(0,t.length).reverse();for(g=0;g<t.length;g++)h?(B[g].color=f,genericPlain(t[t.length-1-g],B[g],d)):genericPlain(t[g],B[g],d);var C;if(h)genericAxis({orientation:"bottom",drawTarget:p[1][2][0][0],scale:d3.scale.ordinal().domain(a.items).rangeRoundBands([0,x],0),yShift:-c.height*o*.55,tickSize:0});else for(C=d3.select(p[1][2][0][0]).selectAll("g").data(t).enter().append("g").attr("width",x).attr("height",c.height*o).attr("transform",function(a,b){return"translate("+b*(x+w)+", 0)"}),g=0;g<C[0].length;g++)genericAxis({orientation:"bottom",drawTarget:C[0][g],scale:d3.scale.linear().domain([0,s]).range([0,x])});if(h)for(C=d3.select(p[0][1][0][0]).selectAll("g").data(t).enter().append("g").attr("width",c.width*i).attr("height",y).attr("transform",function(a,b){return"translate(0, "+b*(y+w)+")"}),g=0;g<C[0].length;g++)genericAxis({orientation:"left",drawTarget:C[0][g],scale:d3.scale.linear().domain([0,s]).range([y,0]),xShift:c.width*i,tickAmt:3});else genericAxis({orientation:"left",drawTarget:p[0][1][0][0],scale:d3.scale.ordinal().domain(a.items).rangeRoundBands([0,y],0),xShift:c.width*i,tickSize:0});genericAxis(h?{orientation:"right",drawTarget:p[2][1][0][0],scale:d3.scale.ordinal().domain(a.categories).rangeRoundBands([r,0],0),blank:!0}:{orientation:"bottom",drawTarget:p[1][0][0][0],scale:d3.scale.ordinal().domain(a.categories).rangeRoundBands([0,q],0),blank:!0,xShift:-c.width*i*.2,yShift:c.height*l*.7}),d3.select(p[2][1][0][0]).selectAll("text").attr("fullText",function(a){return a}),d3.select(p[2][1][0][0]).selectAll("text").text(function(a){return b(a,c.width*k)}),d3.select(p[2][1][0][0]).selectAll(".tick").on("mousemove",function(a){n.onMouseMove(a,this,n)}).on("mouseover",function(a){n.onMouseOver(a,this,n)}).on("mouseout",function(a){n.onMouseOut(a,this,n)}).on("click",function(a){n.onClick(a,this,n)})}function i(a,b,c){for(var d="vertical"===b.orientation?!0:!1,e=(a.matrix.map(function(a){return a.max()}).max(),a.matrix.map(function(a){return a.sum()}).max()),f=d3.scale.ordinal().domain(a.categories).range(d3.scale.category10().range()),g=genericSVGFormat({width:b.width,height:b.height,drawTarget:b.drawTarget}),h=.8*b.width,i=.8*b.height,j=[],k=0;k<a.items.length;k++){j.push({}),j[k].item=a.items[k];for(var l=0;l<a.categories.length;l++)j[k][a.categories[l]]=a.matrix[k][l]}j.forEach(d?function(a){var b=0;a.nums=f.domain().map(function(c){return{name:c,y0:b,y1:b+=+a[c]}}),a.total=a.nums[a.nums.length-1].y1}:function(a){var b=0;a.nums=f.domain().map(function(c){return{name:c,x0:b,x1:b+=a[c]}}),a.total=a.nums[a.nums.length-1].x1});var m,n=d?d3.scale.ordinal().domain(j.map(function(a){return a.item})).rangeRoundBands([0,h],.1):d3.scale.linear().domain([0,d3.max(j,function(a){return a.total})]).range([0,h]),o=d?d3.scale.linear().domain([0,d3.max(j,function(a){return a.total})]).range([i,0]):d3.scale.ordinal().domain(j.map(function(a){return a.item})).rangeRoundBands([0,i],.1);d?(m=d3.select(g[1][1][0][0]).selectAll(".item").data(j).enter().append("g").attr("transform",function(a){return"translate("+n(a.item)+", 0)"}),m.selectAll("rect").data(function(a){return a.nums}).enter().append("rect").attr("class","bar").attr("y",function(a){return o(a.y1)}).attr("width",n.rangeBand()).attr("height",function(a){return o(a.y0)-o(a.y1)}).style("fill",function(a){return f(a.name)}).on("mousemove",function(a){c.onMouseMove({id:a.name,value:a.y1-a.y0},this,c)}).on("mouseover",function(a){c.onMouseOver({id:a.name,value:a.y1-a.y0},this,c)}).on("mouseout",function(a){c.onMouseOut({id:a.name,value:a.y1-a.y0},this,c)}).on("click",function(a){c.onClick({id:a.name,value:a.y1-a.y0},this,c)})):(m=d3.select(g[1][1][0][0]).selectAll(".item").data(j).enter().append("g").attr("transform",function(a){return"translate(0, "+o(a.item)+")"}),m.selectAll("rect").data(function(a){return a.nums.reverse()}).enter().append("rect").attr("class","bar").attr("x",function(a){return n(a.x0)}).attr("y",function(a){return o(a.name)}).attr("width",function(a){return n(a.x1)-n(a.x0)}).attr("height",o.rangeBand()).style("fill",function(a){return f(a.name)}).on("mousemove",function(a){c.onMouseMove({id:a.name,value:a.x1-a.x0},this,c)}).on("mouseover",function(a){c.onMouseOver({id:a.name,value:a.x1-a.x0},this,c)}).on("mouseout",function(a){c.onMouseOut({id:a.name,value:a.x1-a.x0},this,c)}).on("click",function(a){c.onClick({id:a.name,value:a.x1-a.x0},this,c)})),genericAxis({orientation:"bottom",drawTarget:g[1][2][0][0],scale:d?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,h],0):d3.scale.linear().domain([0,e]).range([0,h]),tickSize:d?0:6}),genericAxis({orientation:"left",drawTarget:g[0][1][0][0],scale:d?d3.scale.linear().domain([0,e]).range([i,0]):d3.scale.ordinal().domain(a.items).rangeRoundBands([0,i],0),xShift:.1*b.width,tickSize:d?6:0})}function j(a,b,c){d3.select("#"+b.drawTarget).html("");var d=jQuery.extend(!0,{},c),e=jQuery.extend(!0,{},b),j=jQuery.extend(!0,{},m),k=jQuery.extend(!0,{},n);"group"===a?g(d,e,j,k):"layer"===a?h(d,e,j,k):"simple"===a?f(d,e,j,k):"stack"===a?i(d,e,j,k):alert("Invalid chart type"),d3.select("#"+b.drawTarget).selectAll("text").attr("font-family","times new roman").attr("font-size","14px").attr("fill","black").attr("stroke","none")}Array.prototype.max=function(){for(var a=0,b=this.length;b--;)a<this[b]&&(a=this[b]);return a},Array.prototype.sum=function(){for(var a=0,b=this.length;b--;)a+=this[b];return a};var k=d3.select("body").append("div").attr("class","refinery-utility-barTooltip").style("opacity",0).style("position","absolute").style("text-align","center").attr("width","100px").style("background-color","#000").style("opacity","0.8").style("color","#fff").style("font-weight","normal").style("font-size","11.9px").style("border-radius","3px").style("padding","1px 4px 1px 4px"),l=d3.select("body").append("div").attr("class","refinery-utility-labelTooltip").style("opacity",0).style("position","absolute").style("text-align","center").attr("width","100px").style("background-color","#000").style("opacity","0.8").style("color","#fff").style("font-weight","normal").style("font-size","11.9px").style("border-radius","3px").style("padding","1px 4px 1px 4px"),m={onMouseMove:function(a,b,c){c.barTooltipFlag&&c.barTooltip.html(a.id+"<br>"+a.value).style("opacity",.9).style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")},onMouseOver:function(a,b,c){c.barTooltipFlag=!0,d3.select(b.parentNode).selectAll(".bar").attr("opacity",.6),d3.select(b).attr("opacity",1)},onMouseOut:function(a,b,c){c.barTooltipFlag=!1,d3.select(b.parentNode).selectAll(".bar").attr("opacity",1),c.barTooltip.style("opacity",0)},onClick:function(){console.log("clicky action going on")},barTooltip:k,barTooltipFlag:!1},n={onMouseMove:function(a){n.labelTooltipFlag&&l.html(a).style("opacity",.9).style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")},onMouseOver:function(){n.labelTooltipFlag=!0},onMouseOut:function(){n.labelTooltip=!1,l.style("opacity",0)},onClick:function(){},lableTooltip:l,labelTooltipFlag:!1},o={draw:j};return o}()}};