/*! refinery-utility-visualization 2014-06-12 */
var rfnry={vis:{util:function(){function a(a){d3.selectAll("#test").remove();var b=d3.select("body").append("svg").attr("id","test").attr("width",0).attr("height",0).selectAll("text").data([1]).enter().append("text").text(a);return b[0][0].getBBox().width}function b(b,c){if(a(b)<=c)return b;for(var d=0;d<b.length/2;d++){var e=b.substring(0,b.length/2-d)+".."+b.substring(b.length/2+d,b.length);if(a(e)<=c)return e}}function c(a,b,c){var d=b.width,e=b.height,f=b.globalMax,g="vertical"===b.orientation?!0:!1,h=g?.01*d:.01*e,i=e/a.length-h,j=d3.scale.linear().domain([0,f]).range([0,d]),k=d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,e],0);g&&(i=d/a.length-h,j=d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,d],0),k=d3.scale.linear().domain([0,f]).range([e,0])),d3.select(b.drawTarget).selectAll("rect").data(a).enter().append("rect").attr("class","bar").attr("x",function(a){return g?j(a.id):0}).attr("y",function(a){return k(g?a.value:a.id)}).attr("width",function(a){return g?i:j(a.value)}).attr("height",function(a){return g?e-k(a.value):i}).style("fill",function(a){return b.color(a.id)}).on("mousemove",function(a){c.onMouseMove(a,this,c)}).on("mouseover",function(a){c.onMouseOver(a,this,c)}).on("mouseout",function(a){c.onMouseOut(a,this,c)}).on("click",function(a){c.onClick(a,this,c)})}function d(a){var b=a.width,c=a.height,d=a.drawTarget,e=a.hLeft||.1,f=a.hMid||.8,g=a.hRight||.1,h=a.vTop||.1,i=a.vMid||.8,j=a.vBot||.1,k=1e-4;(Math.abs(e+f+g-1)>k||Math.abs(h+i+j-1)>k)&&console.err("FormatError: partition percentages exceed or do not add up to 1"),d3.select("#"+d).html("");var l=d3.select("#"+d).append("svg").attr("width",b).attr("height",c),m=b*e,n=b*(e+f),o=c*h,p=c*(h+i),q=l.selectAll(".leftTop").data([1]).enter().append("g").attr("width",b*e).attr("height",c*h).attr("transform","translate(0, 0)"),r=l.selectAll(".leftMid").data([1]).enter().append("g").attr("width",b*e).attr("height",c*i).attr("transform","translate(0, "+o+")"),s=l.selectAll(".leftBot").data([1]).enter().append("g").attr("width",b*e).attr("height",c*j).attr("transform","translate(0, "+p+")"),t=l.selectAll(".midTop").data([1]).enter().append("g").attr("width",b*f).attr("height",c*h).attr("transform","translate("+m+", 0)"),u=l.selectAll(".midMid").data([1]).enter().append("g").attr("width",b*f).attr("height",c*i).attr("transform","translate("+m+", "+o+")"),v=l.selectAll(".midBot").data([1]).enter().append("g").attr("width",b*f).attr("height",c*j).attr("transform","translate("+m+", "+p+")"),w=l.selectAll(".rightTop").data([1]).enter().append("g").attr("width",b*g).attr("height",c*h).attr("transform","translate("+n+", 0)"),x=l.selectAll(".rightMid").data([1]).enter().append("g").attr("width",b*g).attr("height",c*i).attr("transform","translate("+n+", "+o+")"),y=l.selectAll(".rightBot").data([1]).enter().append("g").attr("width",b*g).attr("height",c*j).attr("transform","translate("+n+", "+p+")");return[[q,r,s],[t,u,v],[w,x,y]]}function e(a){var b=a.orientation,c=a.drawTarget,d=a.scale,e=a.xShift||0,f=a.yShift||0,g=a.tickAmt||5,h=void 0===a.tickSize?6:a.tickSize,i=a.axisClass||"refinery-utility-axis",j=a.blank||!1;j&&(i="refinery-utility-blankaxis");var k=d3.svg.axis().scale(d).orient(b).ticks(g).tickSize(h);d3.select(c).selectAll("axis").data([1]).enter().append("g").attr("class",i).attr("transform","translate("+e+", "+f+")").style("fill","none").style("stroke",j?"none":"black").call(k)}function f(a,b,f){for(var g="vertical"===b.orientation?!0:!1,h=.1,i=.8,j=.8,k=d({width:b.width,height:b.height,drawTarget:b.drawTarget}),l=b.width*i,m=b.height*j,n=[],o=0;o<a.items.length;o++)n.push({id:a.items[o],value:a.matrix[o].sum()});var p=n.map(function(a){return a.value}).max(),q=l,r=m;c(n,{globalMax:p,orientation:b.orientation,width:l,height:m,drawTarget:k[1][1][0][0],color:d3.scale.category10().domain(n.map(function(a){return a.id}))},f),e({orientation:"bottom",drawTarget:k[1][2][0][0],tickSize:g?0:6,scale:g?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,q],0):d3.scale.linear().domain([0,p]).range([0,q])}),e({orientation:"left",drawTarget:k[0][1][0][0],tickSize:g?6:0,scale:g?d3.scale.linear().domain([0,p]).range([r,0]):d3.scale.ordinal().domain(a.items.reverse()).rangeRoundBands([r,0],0),xShift:h*b.width})}function g(a,b,f){function g(a){return a.id}var h=0,i="vertical"===b.orientation?!0:!1,j=.8,k=.8,l=d({width:b.width,height:b.height,drawTarget:b.drawTarget}),m=b.width*j,n=b.height*k,o=a.matrix.map(function(a){return a.max()}).max(),p=[];for(h=0;h<a.items.length;h++){for(var q=[],r=0;r<a.matrix[h].length;r++)q.push({id:a.items[h]+"-"+a.categories[r],value:a.matrix[h][r]});p.push(q)}var s=i?.01*m:.01*n,t=i?m/p.length-s:m,u=i?n:n/p.length-s,v=d3.select(l[1][1][0][0]).selectAll("g").data(p).enter().append("g").attr("width",t).attr("height",u).attr("transform",function(a,b){return i?"translate("+b*(t+s)+", 0)":"translate(0, "+b*(u+s)+")"}),w=[];for(h=0;h<v[0].length;h++)w.push({width:t,height:u,orientation:b.orientation,drawTarget:v[0][h],globalMax:o,color:d3.scale.category10().domain(p[h].map(g))});for(h=0;h<p.length;h++)c(p[h],w[h],f);e({orientation:"bottom",drawTarget:l[1][2][0][0],scale:i?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,m],0):d3.scale.linear().domain([0,o]).range([0,t]),xShift:0,yShift:0,tickSize:i?0:6}),e({orientation:"left",drawTarget:l[0][1][0][0],scale:i?d3.scale.linear().domain([0,o]).range([n,0]):d3.scale.ordinal().domain(a.items.reverse()).rangeRoundBands([n,0],0),xShift:.1*b.width,yShift:0,tickSize:i?6:0})}function h(a,f,g){function h(){return D[j]}function i(){return D[j]}var j=0,k="vertical"===f.orientation?!0:!1,l=.1,m=.8,o=.1,p=.1,q=.8,r=.1,s=d({width:f.width,height:f.height,drawTarget:f.drawTarget,hLeft:l,hMid:m,hRight:o,vTop:p,vMid:q,vBot:r}),t=f.width*m,u=k?f.height*q:f.height*q,v=a.matrix.map(function(a){return a.max()}).max(),w=[];for(j=0;j<a.categories.length;j++){for(var x=[],y=0;y<a.matrix.length;y++)x.push({id:a.items[y]+"-"+a.categories[j],value:a.matrix[y][j]});w.push(x)}var z=k?.05*t:.05*u,A=k?t:t/w.length-z,B=k?u/w.length-z:u,C=d3.select(k?s[1][1][0][0]:s[1][1][0][0]).selectAll("g").data(w).enter().append("g").attr("width",A).attr("height",B).attr("transform",function(a,b){return k?"translate(0, "+b*(B+z)+")":"translate("+b*(A+z)+", 0)"}),D=d3.scale.category10().range(),E=[];for(j=0;j<C[0].length;j++)E.push({width:A,height:B,orientation:f.orientation,drawTarget:C[0][j],globalMax:v,color:h});d3.scale.category10().range().slice(0,w.length).reverse();for(j=0;j<w.length;j++)k?(E[j].color=i,c(w[w.length-1-j],E[j],g)):c(w[j],E[j],g);var F;if(k)e({orientation:"bottom",drawTarget:s[1][2][0][0],scale:d3.scale.ordinal().domain(a.items).rangeRoundBands([0,A],0),yShift:-f.height*r*.55,tickSize:0});else for(F=d3.select(s[1][2][0][0]).selectAll("g").data(w).enter().append("g").attr("width",A).attr("height",f.height*r).attr("transform",function(a,b){return"translate("+b*(A+z)+", 0)"}),j=0;j<F[0].length;j++)e({orientation:"bottom",drawTarget:F[0][j],scale:d3.scale.linear().domain([0,v]).range([0,A])});if(k)for(F=d3.select(s[0][1][0][0]).selectAll("g").data(w).enter().append("g").attr("width",f.width*l).attr("height",B).attr("transform",function(a,b){return"translate(0, "+b*(B+z)+")"}),j=0;j<F[0].length;j++)e({orientation:"left",drawTarget:F[0][j],scale:d3.scale.linear().domain([0,v]).range([B,0]),xShift:f.width*l,tickAmt:3});else e({orientation:"left",drawTarget:s[0][1][0][0],scale:d3.scale.ordinal().domain(a.items).rangeRoundBands([0,B],0),xShift:f.width*l,tickSize:0});e(k?{orientation:"right",drawTarget:s[2][1][0][0],scale:d3.scale.ordinal().domain(a.categories).rangeRoundBands([u,0],0),blank:!0}:{orientation:"bottom",drawTarget:s[1][0][0][0],scale:d3.scale.ordinal().domain(a.categories).rangeRoundBands([0,t],0),blank:!0,xShift:-f.width*l*.2,yShift:f.height*p*.7}),d3.select(s[2][1][0][0]).selectAll("text").attr("fullText",function(a){return a}),d3.select(s[2][1][0][0]).selectAll("text").text(function(a){return b(a,f.width*o)}),d3.select(s[2][1][0][0]).selectAll(".tick").on("mousemove",function(a){n.onMouseMove(a,this,n)}).on("mouseover",function(a){n.onMouseOver(a,this,n)}).on("mouseout",function(a){n.onMouseOut(a,this,n)}).on("click",function(a){n.onClick(a,this,n)})}function i(a,b,c){for(var f="vertical"===b.orientation?!0:!1,g=(a.matrix.map(function(a){return a.max()}).max(),a.matrix.map(function(a){return a.sum()}).max()),h=d3.scale.ordinal().domain(a.categories).range(d3.scale.category10().range()),i=d({width:b.width,height:b.height,drawTarget:b.drawTarget}),j=.8*b.width,k=.8*b.height,l=[],m=0;m<a.items.length;m++){l.push({}),l[m].item=a.items[m];for(var n=0;n<a.categories.length;n++)l[m][a.categories[n]]=a.matrix[m][n]}l.forEach(f?function(a){var b=0;a.nums=h.domain().map(function(c){return{name:c,y0:b,y1:b+=+a[c]}}),a.total=a.nums[a.nums.length-1].y1}:function(a){var b=0;a.nums=h.domain().map(function(c){return{name:c,x0:b,x1:b+=a[c]}}),a.total=a.nums[a.nums.length-1].x1});var o,p=f?d3.scale.ordinal().domain(l.map(function(a){return a.item})).rangeRoundBands([0,j],.1):d3.scale.linear().domain([0,d3.max(l,function(a){return a.total})]).range([0,j]),q=f?d3.scale.linear().domain([0,d3.max(l,function(a){return a.total})]).range([k,0]):d3.scale.ordinal().domain(l.map(function(a){return a.item})).rangeRoundBands([0,k],.1);f?(o=d3.select(i[1][1][0][0]).selectAll(".item").data(l).enter().append("g").attr("transform",function(a){return"translate("+p(a.item)+", 0)"}),o.selectAll("rect").data(function(a){return a.nums}).enter().append("rect").attr("class","bar").attr("y",function(a){return q(a.y1)}).attr("width",p.rangeBand()).attr("height",function(a){return q(a.y0)-q(a.y1)}).style("fill",function(a){return h(a.name)}).on("mousemove",function(a){c.onMouseMove({id:a.name,value:a.y1-a.y0},this,c)}).on("mouseover",function(a){c.onMouseOver({id:a.name,value:a.y1-a.y0},this,c)}).on("mouseout",function(a){c.onMouseOut({id:a.name,value:a.y1-a.y0},this,c)}).on("click",function(a){c.onClick({id:a.name,value:a.y1-a.y0},this,c)})):(o=d3.select(i[1][1][0][0]).selectAll(".item").data(l).enter().append("g").attr("transform",function(a){return"translate(0, "+q(a.item)+")"}),o.selectAll("rect").data(function(a){return a.nums.reverse()}).enter().append("rect").attr("class","bar").attr("x",function(a){return p(a.x0)}).attr("y",function(a){return q(a.name)}).attr("width",function(a){return p(a.x1)-p(a.x0)}).attr("height",q.rangeBand()).style("fill",function(a){return h(a.name)}).on("mousemove",function(a){c.onMouseMove({id:a.name,value:a.x1-a.x0},this,c)}).on("mouseover",function(a){c.onMouseOver({id:a.name,value:a.x1-a.x0},this,c)}).on("mouseout",function(a){c.onMouseOut({id:a.name,value:a.x1-a.x0},this,c)}).on("click",function(a){c.onClick({id:a.name,value:a.x1-a.x0},this,c)})),e({orientation:"bottom",drawTarget:i[1][2][0][0],scale:f?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,j],0):d3.scale.linear().domain([0,g]).range([0,j]),tickSize:f?0:6}),e({orientation:"left",drawTarget:i[0][1][0][0],scale:f?d3.scale.linear().domain([0,g]).range([k,0]):d3.scale.ordinal().domain(a.items).rangeRoundBands([0,k],0),xShift:.1*b.width,tickSize:f?6:0})}function j(a,b,c){d3.select("#"+b.drawTarget).html("");var d=jQuery.extend(!0,{},c),e=jQuery.extend(!0,{},b),j=jQuery.extend(!0,{},m);"group"===a?g(d,e,j):"layer"===a?h(d,e,j):"simple"===a?f(d,e,j):"stack"===a?i(d,e,j):alert("Invalid chart type"),d3.select("#"+b.drawTarget).selectAll("text").attr("font-family","times new roman").attr("font-size","14px").attr("fill","black").attr("stroke","none")}Array.prototype.max=function(){for(var a=0,b=this.length;b--;)a<this[b]&&(a=this[b]);return a},Array.prototype.sum=function(){for(var a=0,b=this.length;b--;)a+=this[b];return a};var k=d3.select("body").append("div").attr("class","refinery-utility-barTooltip").style("opacity",0).style("position","absolute").style("text-align","center").attr("width","100px").style("background-color","#000").style("opacity","0.8").style("color","#fff").style("font-weight","normal").style("font-size","11.9px").style("border-radius","3px").style("padding","1px 4px 1px 4px"),l=d3.select("body").append("div").attr("class","refinery-utility-labelTooltip").style("opacity",0).style("position","absolute").style("text-align","center").attr("width","100px").style("background-color","#000").style("opacity","0.8").style("color","#fff").style("font-weight","normal").style("font-size","11.9px").style("border-radius","3px").style("padding","1px 4px 1px 4px"),m={onMouseMove:function(a,b,c){c.barTooltipFlag&&c.barTooltip.html(a.id+"<br>"+a.value).style("opacity",.9).style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")},onMouseOver:function(a,b,c){c.barTooltipFlag=!0,d3.select(b.parentNode).selectAll(".bar").attr("opacity",.6),d3.select(b).attr("opacity",1)},onMouseOut:function(a,b,c){c.barTooltipFlag=!1,d3.select(b.parentNode).selectAll(".bar").attr("opacity",1),c.barTooltip.style("opacity",0)},onClick:function(){console.log("clicky action going on")},barTooltip:k,barTooltipFlag:!1},n={onMouseMove:function(a){console.log("mouse moving"),n.labelTooltipFlag&&(console.log(n),console.log(l),l.html(a).style("opacity",.9).style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px"))},onMouseOver:function(){console.log("mouse overing"),n.labelTooltipFlag=!0},onMouseOut:function(){console.log("mouse outing"),n.labelTooltip=!1,l.style("opacity",0)},onClick:function(a,b){console.log("CLICKY THING OGIN GOIN TOIJEOIFDJ"),console.log(a),console.log(b)},lableTooltip:l,labelTooltipFlag:!1};console.log(l);var o={draw:j};return o}()}};