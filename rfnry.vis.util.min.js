/*! refinery-utility-visualization 2014-06-19 */
var rfnry={vis:{util:function(){function a(a){d3.selectAll("#test").remove();var b=d3.select("body").append("svg").attr("id","test").attr("width",0).attr("height",0).selectAll("text").data([1]).enter().append("text").text(a);return b[0][0].getBBox()}function b(b){return a(b).width}function c(b){return a(b).height}function d(a,c){if(b(a)<=c)return a;for(var d=0;d<a.length/2;d++){var e=a.substring(0,a.length/2-d)+".."+a.substring(a.length/2+d,a.length);if(b(e)<=c)return e}}function e(a,b,c){var d=b.width,e=b.height,f=b.globalMax,g="vertical"===b.orientation?!0:!1,h=b.color||d3.scale.category10().domain(a.map(function(a){return a.id})),i=g?.01*d:.01*e,j=e/a.length-i,k=d3.scale.linear().domain([0,f]).range([0,d]),l=d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,e],0);g&&(j=d/a.length-i,k=d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,d],0),l=d3.scale.linear().domain([0,f]).range([e,0])),d3.select(b.drawTarget).selectAll("rect").data(a).enter().append("rect").attr("class","bar").attr("x",function(a){return g?k(a.id):0}).attr("y",function(a){return l(g?a.value:a.id)}).attr("width",function(a){return g?j:k(a.value)}).attr("height",function(a){return g?e-l(a.value):j}).style("fill",function(a){return h(a.id)}).on("mousemove",function(a){c.onMouseMove(a,this,c)}).on("mouseover",function(a){c.onMouseOver(a,this,c)}).on("mouseout",function(a){c.onMouseOut(a,this,c)}).on("click",function(a){c.onClick(a,this,c)})}function f(a){var b=a.width,c=a.height,d=a.drawTarget,e=a.hLeft||.1,f=a.hMid||.8,g=a.hRight||.1,h=a.vTop||.1,i=a.vMid||.8,j=a.vBot||.1,k=1e-4;(Math.abs(e+f+g-1)>k||Math.abs(h+i+j-1)>k)&&console.err("FormatError: partition percentages exceed or do not add up to 1"),d3.select("#"+d).html("");var l=d3.select("#"+d).append("svg").attr("width",b).attr("height",c),m=b*e,n=b*(e+f),o=c*h,p=c*(h+i),q=l.selectAll(".leftTop").data([1]).enter().append("g").attr("width",b*e).attr("height",c*h).attr("transform","translate(0, 0)"),r=l.selectAll(".leftMid").data([1]).enter().append("g").attr("width",b*e).attr("height",c*i).attr("transform","translate(0, "+o+")"),s=l.selectAll(".leftBot").data([1]).enter().append("g").attr("width",b*e).attr("height",c*j).attr("transform","translate(0, "+p+")"),t=l.selectAll(".midTop").data([1]).enter().append("g").attr("width",b*f).attr("height",c*h).attr("transform","translate("+m+", 0)"),u=l.selectAll(".midMid").data([1]).enter().append("g").attr("width",b*f).attr("height",c*i).attr("transform","translate("+m+", "+o+")"),v=l.selectAll(".midBot").data([1]).enter().append("g").attr("width",b*f).attr("height",c*j).attr("transform","translate("+m+", "+p+")"),w=l.selectAll(".rightTop").data([1]).enter().append("g").attr("width",b*g).attr("height",c*h).attr("transform","translate("+n+", 0)"),x=l.selectAll(".rightMid").data([1]).enter().append("g").attr("width",b*g).attr("height",c*i).attr("transform","translate("+n+", "+o+")"),y=l.selectAll(".rightBot").data([1]).enter().append("g").attr("width",b*g).attr("height",c*j).attr("transform","translate("+n+", "+p+")");return[[q,r,s],[t,u,v],[w,x,y]]}function g(a,b){var c=a.orientation,e=a.drawTarget,f=a.scale,g=a.xShift||0,h=a.yShift||0,i=a.tickAmt||5,j=void 0===a.tickSize?6:a.tickSize,k=a.axisClass||"refinery-utility-axis",l=a.blank||!1;maxLabelSize=a.maxLabelSize||1e3,l&&(k="refinery-utility-blankaxis");var m=d3.svg.axis().scale(f).orient(c).ticks(i).tickSize(j),n=d3.select(e);n.selectAll("axis").data([1]).enter().append("g").attr("class",k).attr("transform","translate("+g+", "+h+")").style("fill","none").style("stroke",l?"none":"black").call(m),n.selectAll("text").text(function(a){return d(a,maxLabelSize)}),n.selectAll(".tick").on("mousemove",function(a){b.onMouseMove(a,this,b)}).on("mouseover",function(a){b.onMouseOver(a,this,b)}).on("mouseout",function(a){b.onMouseOut(a,this,b)}).on("click",function(a){b.onClick(a,this,b)})}function h(a,b,c,d){for(var h="vertical"===b.orientation?!0:!1,i=.1,j=.8,k=.8,l=b.width*j,m=b.height*k,n=f({width:b.width,height:b.height,drawTarget:b.drawTarget}),o=[],p=0;p<a.items.length;p++)o.push({id:a.items[p],value:a.matrix[p].sum()});var q=o.map(function(a){return a.value}).max(),r=l,s=m;e(o,{globalMax:q,orientation:b.orientation,width:l,height:m,drawTarget:n[1][1][0][0]},c),g({orientation:"bottom",drawTarget:n[1][2][0][0],tickSize:h?0:6,scale:h?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,r],0):d3.scale.linear().domain([0,q]).range([0,r]),maxLabelSize:h?l/o.length*.9:1e3},d),g({orientation:"left",drawTarget:n[0][1][0][0],tickSize:h?6:0,scale:h?d3.scale.linear().domain([0,q]).range([s,0]):d3.scale.ordinal().domain(a.items.reverse()).rangeRoundBands([s,0],0),maxLabelSize:.1*b.width*.9,xShift:i*b.width},d)}function i(a,b,c,d){var h=0,i="vertical"===b.orientation?!0:!1,j=.8,k=.8,l=f({width:b.width,height:b.height,drawTarget:b.drawTarget}),m=b.width*j,n=b.height*k,o=a.matrix.map(function(a){return a.max()}).max(),p=[];for(h=0;h<a.items.length;h++){for(var q=[],r=0;r<a.matrix[h].length;r++)q.push({id:a.items[h]+"-"+a.categories[r],value:a.matrix[h][r]});p.push(q)}var s=i?.01*m:.01*n,t=i?m/p.length-s:m,u=i?n:n/p.length-s,v=d3.select(l[1][1][0][0]).selectAll("g").data(p).enter().append("g").attr("width",t).attr("height",u).attr("transform",function(a,b){return i?"translate("+b*(t+s)+", 0)":"translate(0, "+b*(u+s)+")"}),w=[];for(h=0;h<v[0].length;h++)w.push({width:t,height:u,orientation:b.orientation,drawTarget:v[0][h],globalMax:o});for(h=0;h<p.length;h++)e(p[h],w[h],c);g({orientation:"bottom",drawTarget:l[1][2][0][0],scale:i?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,m],0):d3.scale.linear().domain([0,o]).range([0,t]),xShift:0,yShift:0,tickSize:i?0:6,maxLabelSize:i?.9*t:1e3},d),g({orientation:"left",drawTarget:l[0][1][0][0],scale:i?d3.scale.linear().domain([0,o]).range([n,0]):d3.scale.ordinal().domain(a.items.reverse()).rangeRoundBands([n,0],0),xShift:.1*b.width,yShift:0,tickSize:i?6:0,maxLabelSize:.1*b.width*.9},d)}function j(a,d,h,i){function j(){return E[l]}function k(){return E[l]}var l=0,m="vertical"===d.orientation?!0:!1,n=.1,o=.8,p=.1,q=.1,r=.8,s=.1,t=f({width:d.width,height:d.height,drawTarget:d.drawTarget,hLeft:n,hMid:o,hRight:p,vTop:q,vMid:r,vBot:s}),u=d.width*o,v=d.height*r,w=a.matrix.map(function(a){return a.max()}).max(),x=[];for(l=0;l<a.categories.length;l++){for(var y=[],z=0;z<a.matrix.length;z++)y.push({id:a.items[z]+"-"+a.categories[l],value:a.matrix[z][l]});x.push(y)}var A=m?c("1234567890"):b("W"),B=m?u:u/x.length-A,C=m?v/x.length-A:v,D=d3.select(m?t[1][1][0][0]:t[1][1][0][0]).selectAll("g").data(x).enter().append("g").attr("width",B).attr("height",C).attr("transform",function(a,b){return m?"translate(0, "+b*(C+A)+")":"translate("+b*(B+A)+", 0)"}),E=d3.scale.category10().range(),F=[];for(l=0;l<D[0].length;l++)F.push({width:B,height:C,orientation:d.orientation,drawTarget:D[0][l],globalMax:w,color:j});d3.scale.category10().range().slice(0,x.length).reverse();for(l=0;l<x.length;l++)m?(F[l].color=k,e(x[x.length-1-l],F[l],h)):e(x[l],F[l],h);var G;if(m)g({orientation:"bottom",drawTarget:t[1][2][0][0],scale:d3.scale.ordinal().domain(a.items).rangeRoundBands([0,B],0),tickSize:0,maxLabelSize:u/x.length*.9,yShift:-c("W")},i);else for(G=d3.select(t[1][2][0][0]).selectAll("g").data(x).enter().append("g").attr("width",B).attr("height",d.height*s).attr("transform",function(a,b){return"translate("+b*(B+A)+", 0)"}),l=0;l<G[0].length;l++)g({orientation:"bottom",drawTarget:G[0][l],scale:d3.scale.linear().domain([0,w]).range([0,B]),tickAmt:3},i);if(m)for(G=d3.select(t[0][1][0][0]).selectAll("g").data(x).enter().append("g").attr("width",d.width*n).attr("height",C).attr("transform",function(a,b){return"translate(0, "+b*(C+A)+")"}),l=0;l<G[0].length;l++)g({orientation:"left",drawTarget:G[0][l],scale:d3.scale.linear().domain([0,w]).range([C,0]),xShift:d.width*n,tickAmt:3},i);else g({orientation:"left",drawTarget:t[0][1][0][0],scale:d3.scale.ordinal().domain(a.items).rangeRoundBands([0,C],0),xShift:d.width*n,tickSize:0,maxLabelSize:d.width*n*.9},i);m?g({orientation:"right",drawTarget:t[2][1][0][0],scale:d3.scale.ordinal().domain(a.categories).rangeRoundBands([v,0],0),blank:!0,maxLabelSize:.1*d.width*.9},i):g({orientation:"bottom",drawTarget:t[1][0][0][0],scale:d3.scale.ordinal().domain(a.categories).rangeRoundBands([0,u],0),blank:!0,maxLabelSize:u/x.length*.9,yShift:.5*(.1*d.height-c("Wgy"))},i)}function k(a,b,c,d){for(var e="vertical"===b.orientation?!0:!1,h=(a.matrix.map(function(a){return a.max()}).max(),a.matrix.map(function(a){return a.sum()}).max()),i=d3.scale.ordinal().domain(a.categories).range(d3.scale.category10().range()),j=f({width:b.width,height:b.height,drawTarget:b.drawTarget}),k=.8*b.width,l=.8*b.height,m=[],n=0;n<a.items.length;n++){m.push({}),m[n].item=a.items[n];for(var o=0;o<a.categories.length;o++)m[n][a.categories[o]]=a.matrix[n][o]}m.forEach(e?function(a){var b=0;a.nums=i.domain().map(function(c){return{name:c,y0:b,y1:b+=+a[c]}}),a.total=a.nums[a.nums.length-1].y1}:function(a){var b=0;a.nums=i.domain().map(function(c){return{name:c,x0:b,x1:b+=a[c]}}),a.total=a.nums[a.nums.length-1].x1});var p,q=e?d3.scale.ordinal().domain(m.map(function(a){return a.item})).rangeRoundBands([0,k],.1):d3.scale.linear().domain([0,d3.max(m,function(a){return a.total})]).range([0,k]),r=e?d3.scale.linear().domain([0,d3.max(m,function(a){return a.total})]).range([l,0]):d3.scale.ordinal().domain(m.map(function(a){return a.item})).rangeRoundBands([0,l],.1);e?(p=d3.select(j[1][1][0][0]).selectAll(".item").data(m).enter().append("g").attr("transform",function(a){return"translate("+q(a.item)+", 0)"}),p.selectAll("rect").data(function(a){return a.nums}).enter().append("rect").attr("class","bar").attr("y",function(a){return r(a.y1)}).attr("width",q.rangeBand()).attr("height",function(a){return r(a.y0)-r(a.y1)}).style("fill",function(a){return i(a.name)}).on("mousemove",function(a){c.onMouseMove({id:a.name,value:a.y1-a.y0},this,c)}).on("mouseover",function(a){c.onMouseOver({id:a.name,value:a.y1-a.y0},this,c)}).on("mouseout",function(a){c.onMouseOut({id:a.name,value:a.y1-a.y0},this,c)}).on("click",function(a){c.onClick({id:a.name,value:a.y1-a.y0},this,c)})):(p=d3.select(j[1][1][0][0]).selectAll(".item").data(m).enter().append("g").attr("transform",function(a){return"translate(0, "+r(a.item)+")"}),p.selectAll("rect").data(function(a){return a.nums.reverse()}).enter().append("rect").attr("class","bar").attr("x",function(a){return q(a.x0)}).attr("y",function(a){return r(a.name)}).attr("width",function(a){return q(a.x1)-q(a.x0)}).attr("height",r.rangeBand()).style("fill",function(a){return i(a.name)}).on("mousemove",function(a){c.onMouseMove({id:a.name,value:a.x1-a.x0},this,c)}).on("mouseover",function(a){c.onMouseOver({id:a.name,value:a.x1-a.x0},this,c)}).on("mouseout",function(a){c.onMouseOut({id:a.name,value:a.x1-a.x0},this,c)}).on("click",function(a){c.onClick({id:a.name,value:a.x1-a.x0},this,c)})),g({orientation:"bottom",drawTarget:j[1][2][0][0],scale:e?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,k],0):d3.scale.linear().domain([0,h]).range([0,k]),tickSize:e?0:6,maxLabelSize:e?k/m.length*.9:1e3},d),g({orientation:"left",drawTarget:j[0][1][0][0],scale:e?d3.scale.linear().domain([0,h]).range([l,0]):d3.scale.ordinal().domain(a.items).rangeRoundBands([0,l],0),xShift:.1*b.width,tickSize:e?6:0,maxLabelSize:.1*b.width*.9},d)}function l(a,b,c){d3.select("#"+b.drawTarget).html("");var d=jQuery.extend(!0,{},c),e=jQuery.extend(!0,{},b),f=jQuery.extend(!0,{},o),g=jQuery.extend(!0,{},p);"group"===a?i(d,e,f,g):"layer"===a?j(d,e,f,g):"simple"===a?h(d,e,f,g):"stack"===a?k(d,e,f,g):alert("Invalid chart type"),d3.select("#"+b.drawTarget).selectAll("text").attr("font-family","times new roman").attr("font-size","14px").attr("fill","black").attr("stroke","none")}Array.prototype.max=function(){for(var a=0,b=this.length;b--;)a<this[b]&&(a=this[b]);return a},Array.prototype.sum=function(){for(var a=0,b=this.length;b--;)a+=this[b];return a};var m=d3.select("body").append("div").attr("class","refinery-utility-barTooltip").style("opacity",0).style("position","absolute").style("text-align","center").attr("width","100px").style("background-color","#000").style("opacity","0.8").style("color","#fff").style("font-weight","normal").style("font-size","11.9px").style("border-radius","3px").style("padding","1px 4px 1px 4px"),n=d3.select("body").append("div").attr("class","refinery-utility-labelTooltip").style("opacity",0).style("position","absolute").style("text-align","center").attr("width","100px").style("background-color","#000").style("opacity","0.8").style("color","#fff").style("font-weight","normal").style("font-size","11.9px").style("border-radius","3px").style("padding","1px 4px 1px 4px"),o={onMouseMove:function(a,b,c){c.barTooltipFlag&&c.barTooltip.html(a.id+"<br>"+a.value).style("opacity",.9).style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")},onMouseOver:function(a,b,c){c.barTooltipFlag=!0,d3.select(b.parentNode).selectAll(".bar").attr("opacity",.6),d3.select(b).attr("opacity",1)},onMouseOut:function(a,b,c){c.barTooltipFlag=!1,d3.select(b.parentNode).selectAll(".bar").attr("opacity",1),c.barTooltip.style("opacity",0)},onClick:function(){console.log("clicky bar action going on")},barTooltip:m,barTooltipFlag:!1},p={onMouseMove:function(a){p.labelTooltipFlag&&n.html(a).style("opacity",.9).style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")},onMouseOver:function(){p.labelTooltipFlag=!0},onMouseOut:function(){p.labelTooltip=!1,n.style("opacity",0)},onClick:function(){console.log("clicky label action going on")},lableTooltip:n,labelTooltipFlag:!1},q={draw:l};return q}()}};