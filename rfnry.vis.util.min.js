/*! refinery-utility-visualization 2014-06-12 */
var rfnry={vis:{util:function(){function a(a,b,c){var d=b.width,e=b.height,f=b.globalMax,g="vertical"===b.orientation?!0:!1,h=g?.01*d:.01*e,i=e/a.length-h,j=d3.scale.linear().domain([0,f]).range([0,d]),k=d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,e],0);g&&(i=d/a.length-h,j=d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,d],0),k=d3.scale.linear().domain([0,f]).range([e,0])),d3.select(b.drawTarget).selectAll("rect").data(a).enter().append("rect").attr("class","bar").attr("x",function(a){return g?j(a.id):0}).attr("y",function(a){return k(g?a.value:a.id)}).attr("width",function(a){return g?i:j(a.value)}).attr("height",function(a){return g?e-k(a.value):i}).style("fill",function(a){return b.color(a.id)}).on("mousemove",function(a){c.onMouseMove(a,this,c)}).on("mouseover",function(a){c.onMouseOver(a,this,c)}).on("mouseout",function(a){c.onMouseOut(a,this,c)}).on("click",function(a){c.onClick(a,this,c)})}function b(a){var b=a.width,c=a.height,d=a.drawTarget,e=a.hLeft||.1,f=a.hMid||.8,g=a.hRight||.1,h=a.vTop||.1,i=a.vMid||.8,j=a.vBot||.1,k=1e-4;(Math.abs(e+f+g-1)>k||Math.abs(h+i+j-1)>k)&&console.err("FormatError: partition percentages exceed or do not add up to 1"),d3.select("#"+d).html("");var l=d3.select("#"+d).append("svg").attr("width",b).attr("height",c),m=b*e,n=b*(e+f),o=c*h,p=c*(h+i),q=l.selectAll(".leftTop").data([1]).enter().append("g").attr("width",b*e).attr("height",c*h).attr("transform","translate(0, 0)"),r=l.selectAll(".leftMid").data([1]).enter().append("g").attr("width",b*e).attr("height",c*i).attr("transform","translate(0, "+o+")"),s=l.selectAll(".leftBot").data([1]).enter().append("g").attr("width",b*e).attr("height",c*j).attr("transform","translate(0, "+p+")"),t=l.selectAll(".midTop").data([1]).enter().append("g").attr("width",b*f).attr("height",c*h).attr("transform","translate("+m+", 0)"),u=l.selectAll(".midMid").data([1]).enter().append("g").attr("width",b*f).attr("height",c*i).attr("transform","translate("+m+", "+o+")"),v=l.selectAll(".midBot").data([1]).enter().append("g").attr("width",b*f).attr("height",c*j).attr("transform","translate("+m+", "+p+")"),w=l.selectAll(".rightTop").data([1]).enter().append("g").attr("width",b*g).attr("height",c*h).attr("transform","translate("+n+", 0)"),x=l.selectAll(".rightMid").data([1]).enter().append("g").attr("width",b*g).attr("height",c*i).attr("transform","translate("+n+", "+o+")"),y=l.selectAll(".rightBot").data([1]).enter().append("g").attr("width",b*g).attr("height",c*j).attr("transform","translate("+n+", "+p+")");return[[q,r,s],[t,u,v],[w,x,y]]}function c(a){var b=a.orientation,c=a.drawTarget,d=a.scale,e=a.xShift||0,f=a.yShift||0,g=a.tickAmt||5,h=void 0===a.tickSize?6:a.tickSize,i=a.axisClass||"refinery-utility-axis",j=a.blank||!1;j&&(i="refinery-utility-blankaxis");var k=d3.svg.axis().scale(d).orient(b).ticks(g).tickSize(h);d3.select(c).selectAll("axis").data([1]).enter().append("g").attr("class",i).attr("transform","translate("+e+", "+f+")").style("fill","none").style("stroke",j?"none":"black").call(k)}function d(d,e,f){for(var g="vertical"===e.orientation?!0:!1,h=.1,i=.8,j=.8,k=b({width:e.width,height:e.height,drawTarget:e.drawTarget}),l=e.width*i,m=e.height*j,n=[],o=0;o<d.items.length;o++)n.push({id:d.items[o],value:d.matrix[o].sum()});var p=n.map(function(a){return a.value}).max(),q=l,r=m;a(n,{globalMax:p,orientation:e.orientation,width:l,height:m,drawTarget:k[1][1][0][0],color:d3.scale.category10().domain(n.map(function(a){return a.id}))},f),c({orientation:"bottom",drawTarget:k[1][2][0][0],tickSize:g?0:6,scale:g?d3.scale.ordinal().domain(d.items).rangeRoundBands([0,q],0):d3.scale.linear().domain([0,p]).range([0,q])}),c({orientation:"left",drawTarget:k[0][1][0][0],tickSize:g?6:0,scale:g?d3.scale.linear().domain([0,p]).range([r,0]):d3.scale.ordinal().domain(d.items.reverse()).rangeRoundBands([r,0],0),xShift:h*e.width})}function e(d,e,f){function g(a){return a.id}var h=0,i="vertical"===e.orientation?!0:!1,j=.8,k=.8,l=b({width:e.width,height:e.height,drawTarget:e.drawTarget}),m=e.width*j,n=e.height*k,o=d.matrix.map(function(a){return a.max()}).max(),p=[];for(h=0;h<d.items.length;h++){for(var q=[],r=0;r<d.matrix[h].length;r++)q.push({id:d.items[h]+"-"+d.categories[r],value:d.matrix[h][r]});p.push(q)}var s=i?.01*m:.01*n,t=i?m/p.length-s:m,u=i?n:n/p.length-s,v=d3.select(l[1][1][0][0]).selectAll("g").data(p).enter().append("g").attr("width",t).attr("height",u).attr("transform",function(a,b){return i?"translate("+b*(t+s)+", 0)":"translate(0, "+b*(u+s)+")"}),w=[];for(h=0;h<v[0].length;h++)w.push({width:t,height:u,orientation:e.orientation,drawTarget:v[0][h],globalMax:o,color:d3.scale.category10().domain(p[h].map(g))});for(h=0;h<p.length;h++)a(p[h],w[h],f);c({orientation:"bottom",drawTarget:l[1][2][0][0],scale:i?d3.scale.ordinal().domain(d.items).rangeRoundBands([0,m],0):d3.scale.linear().domain([0,o]).range([0,t]),xShift:0,yShift:0,tickSize:i?0:6}),c({orientation:"left",drawTarget:l[0][1][0][0],scale:i?d3.scale.linear().domain([0,o]).range([n,0]):d3.scale.ordinal().domain(d.items.reverse()).rangeRoundBands([n,0],0),xShift:.1*e.width,yShift:0,tickSize:i?6:0})}function f(d,e,f){function g(){return B[i]}function h(){return B[i]}var i=0,j="vertical"===e.orientation?!0:!1,k=.1,l=.8,m=.1,n=.1,o=.8,p=.1,q=b({width:e.width,height:e.height,drawTarget:e.drawTarget,hLeft:k,hMid:l,hRight:m,vTop:n,vMid:o,vBot:p}),r=e.width*l,s=j?e.height*o:e.height*o,t=d.matrix.map(function(a){return a.max()}).max(),u=[];for(i=0;i<d.categories.length;i++){for(var v=[],w=0;w<d.matrix.length;w++)v.push({id:d.items[w]+"-"+d.categories[i],value:d.matrix[w][i]});u.push(v)}var x=j?.05*r:.05*s,y=j?r:r/u.length-x,z=j?s/u.length-x:s,A=d3.select(j?q[1][1][0][0]:q[1][1][0][0]).selectAll("g").data(u).enter().append("g").attr("width",y).attr("height",z).attr("transform",function(a,b){return j?"translate(0, "+b*(z+x)+")":"translate("+b*(y+x)+", 0)"}),B=d3.scale.category10().range(),C=[];for(i=0;i<A[0].length;i++)C.push({width:y,height:z,orientation:e.orientation,drawTarget:A[0][i],globalMax:t,color:g});d3.scale.category10().range().slice(0,u.length).reverse();for(i=0;i<u.length;i++)j?(C[i].color=h,a(u[u.length-1-i],C[i],f)):a(u[i],C[i],f);var D;if(j)c({orientation:"bottom",drawTarget:q[1][2][0][0],scale:d3.scale.ordinal().domain(d.items).rangeRoundBands([0,y],0),yShift:-e.height*p*.55,tickSize:0});else for(D=d3.select(q[1][2][0][0]).selectAll("g").data(u).enter().append("g").attr("width",y).attr("height",e.height*p).attr("transform",function(a,b){return"translate("+b*(y+x)+", 0)"}),i=0;i<D[0].length;i++)c({orientation:"bottom",drawTarget:D[0][i],scale:d3.scale.linear().domain([0,t]).range([0,y])});if(j)for(D=d3.select(q[0][1][0][0]).selectAll("g").data(u).enter().append("g").attr("width",e.width*k).attr("height",z).attr("transform",function(a,b){return"translate(0, "+b*(z+x)+")"}),i=0;i<D[0].length;i++)c({orientation:"left",drawTarget:D[0][i],scale:d3.scale.linear().domain([0,t]).range([z,0]),xShift:e.width*k,tickAmt:3});else c({orientation:"left",drawTarget:q[0][1][0][0],scale:d3.scale.ordinal().domain(d.items).rangeRoundBands([0,z],0),xShift:e.width*k,tickSize:0});c(j?{orientation:"right",drawTarget:q[2][1][0][0],scale:d3.scale.ordinal().domain(d.categories).rangeRoundBands([s,0],0),blank:!0}:{orientation:"bottom",drawTarget:q[1][0][0][0],scale:d3.scale.ordinal().domain(d.categories).rangeRoundBands([0,r],0),blank:!0,xShift:-e.width*k*.2,yShift:e.height*n*.7}),d3.select(q[2][1][0][0]).selectAll("text").attr("hue","oh this is it")}function g(a,d,e){for(var f="vertical"===d.orientation?!0:!1,g=(a.matrix.map(function(a){return a.max()}).max(),a.matrix.map(function(a){return a.sum()}).max()),h=d3.scale.ordinal().domain(a.categories).range(d3.scale.category10().range()),i=b({width:d.width,height:d.height,drawTarget:d.drawTarget}),j=.8*d.width,k=.8*d.height,l=[],m=0;m<a.items.length;m++){l.push({}),l[m].item=a.items[m];for(var n=0;n<a.categories.length;n++)l[m][a.categories[n]]=a.matrix[m][n]}l.forEach(f?function(a){var b=0;a.nums=h.domain().map(function(c){return{name:c,y0:b,y1:b+=+a[c]}}),a.total=a.nums[a.nums.length-1].y1}:function(a){var b=0;a.nums=h.domain().map(function(c){return{name:c,x0:b,x1:b+=a[c]}}),a.total=a.nums[a.nums.length-1].x1});var o,p=f?d3.scale.ordinal().domain(l.map(function(a){return a.item})).rangeRoundBands([0,j],.1):d3.scale.linear().domain([0,d3.max(l,function(a){return a.total})]).range([0,j]),q=f?d3.scale.linear().domain([0,d3.max(l,function(a){return a.total})]).range([k,0]):d3.scale.ordinal().domain(l.map(function(a){return a.item})).rangeRoundBands([0,k],.1);f?(o=d3.select(i[1][1][0][0]).selectAll(".item").data(l).enter().append("g").attr("transform",function(a){return"translate("+p(a.item)+", 0)"}),o.selectAll("rect").data(function(a){return a.nums}).enter().append("rect").attr("class","bar").attr("y",function(a){return q(a.y1)}).attr("width",p.rangeBand()).attr("height",function(a){return q(a.y0)-q(a.y1)}).style("fill",function(a){return h(a.name)}).on("mousemove",function(a){e.onMouseMove({id:a.name,value:a.y1-a.y0},this,e)}).on("mouseover",function(a){e.onMouseOver({id:a.name,value:a.y1-a.y0},this,e)}).on("mouseout",function(a){e.onMouseOut({id:a.name,value:a.y1-a.y0},this,e)}).on("click",function(a){e.onClick({id:a.name,value:a.y1-a.y0},this,e)})):(o=d3.select(i[1][1][0][0]).selectAll(".item").data(l).enter().append("g").attr("transform",function(a){return"translate(0, "+q(a.item)+")"}),o.selectAll("rect").data(function(a){return a.nums.reverse()}).enter().append("rect").attr("class","bar").attr("x",function(a){return p(a.x0)}).attr("y",function(a){return q(a.name)}).attr("width",function(a){return p(a.x1)-p(a.x0)}).attr("height",q.rangeBand()).style("fill",function(a){return h(a.name)}).on("mousemove",function(a){e.onMouseMove({id:a.name,value:a.x1-a.x0},this,e)}).on("mouseover",function(a){e.onMouseOver({id:a.name,value:a.x1-a.x0},this,e)}).on("mouseout",function(a){e.onMouseOut({id:a.name,value:a.x1-a.x0},this,e)}).on("click",function(a){e.onClick({id:a.name,value:a.x1-a.x0},this,e)})),c({orientation:"bottom",drawTarget:i[1][2][0][0],scale:f?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,j],0):d3.scale.linear().domain([0,g]).range([0,j]),tickSize:f?0:6}),c({orientation:"left",drawTarget:i[0][1][0][0],scale:f?d3.scale.linear().domain([0,g]).range([k,0]):d3.scale.ordinal().domain(a.items).rangeRoundBands([0,k],0),xShift:.1*d.width,tickSize:f?6:0})}function h(a,b,c){d3.select("#"+b.drawTarget).html("");var h=jQuery.extend(!0,{},c),i=jQuery.extend(!0,{},b),k=jQuery.extend(!0,{},j);"group"===a?e(h,i,k):"layer"===a?f(h,i,k):"simple"===a?d(h,i,k):"stack"===a?g(h,i,k):alert("Invalid chart type"),d3.select("#"+b.drawTarget).selectAll("text").attr("font-family","times new roman").attr("font-size","14px").attr("fill","black").attr("stroke","none")}Array.prototype.max=function(){for(var a=0,b=this.length;b--;)a<this[b]&&(a=this[b]);return a},Array.prototype.sum=function(){for(var a=0,b=this.length;b--;)a+=this[b];return a};var i=d3.select("body").append("div").attr("class","refinery-utility-tooltip").style("opacity",0).style("position","absolute").style("text-align","center").attr("width","100px").style("background-color","#000").style("opacity","0.8").style("color","#fff").style("font-weight","normal").style("font-size","11.9px").style("border-radius","3px").style("padding","1px 4px 1px 4px"),j={onMouseMove:function(a,b,c){c.tooltipFlag&&c.tooltip.html(a.id+"<br>"+a.value).style("opacity",.9).style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")},onMouseOver:function(a,b,c){c.tooltipFlag=!0,d3.select(b.parentNode).selectAll(".bar").attr("opacity",.6),d3.select(b).attr("opacity",1)},onMouseOut:function(a,b,c){c.tooltipFlag=!1,d3.select(b.parentNode).selectAll(".bar").attr("opacity",1),c.tooltip.style("opacity",0)},onClick:function(){console.log("clicky action going on")},tooltip:i,tooltipFlag:!1},k={draw:h};return k}()}};