/*! refinery-utility-visualization 2014-06-22 */
var rfnry={vis:{util:function(){function a(a){d3.selectAll("#test").remove();var b=d3.select("body").append("svg").attr("id","test").attr("width",0).attr("height",0).selectAll("text").data([1]).enter().append("text").text(a);return b[0][0].getBBox()}function b(b){return a(b).width}function c(b){return a(b).height}function d(a,c){if(b(a)<=c)return a;for(var d=0;d<a.length/2;d++){var e=a.substring(0,a.length/2-d)+".."+a.substring(a.length/2+d,a.length);if(b(e)<=c)return e}}function e(a,b,c){var d="vertical"===b.orientation?!0:!1,e=b.width,f=b.height,g=b.globalMax,h=b.color||d3.scale.category10().domain(a.map(function(a){return a.id})),i=b.barPadding||d?.01*e:.01*f,j=b.barThickness||(d?e:f)/a.length-i,k=b.xScale||(d?d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,e],0):d3.scale.linear().domain([0,g]).range([0,e])),l=b.yScale||(d?d3.scale.linear().domain([0,g]).range([f,0]):d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,f],0));console.log(k.domain()),console.log(k.range()),console.log(a.map(function(a){return a.id})),d3.select(b.drawTarget).selectAll("rect").data(a).enter().append("rect").attr("class","bar").attr("x",function(a){return d?k(a.id):0}).attr("y",function(a){return l(d?a.value:a.id)}).attr("width",function(a){return d?j:k(a.value)}).attr("height",function(a){return d?f-l(a.value):j}).style("fill",function(a){return h(a.id)}).on("mousemove",function(a){c.onMouseMove(a,this,c)}).on("mouseover",function(a){c.onMouseOver(a,this,c)}).on("mouseout",function(a){c.onMouseOut(a,this,c)}).on("click",function(a){c.onClick(a,this,c)})}function f(a){var b=a.width,c=a.height,d=a.drawTarget,e=a.hLeft||.1,f=a.hMid||.8,g=a.hRight||.1,h=a.vTop||.1,i=a.vMid||.8,j=a.vBot||.1;d3.select("#"+d).html("");var k=d3.select("#"+d).append("svg").attr("width",b).attr("height",c),l=b*e,m=b*(e+f),n=c*h,o=c*(h+i),p=k.selectAll(".leftTop").data([1]).enter().append("g").attr("width",b*e).attr("height",c*h).attr("transform","translate(0, 0)"),q=k.selectAll(".leftMid").data([1]).enter().append("g").attr("width",b*e).attr("height",c*i).attr("transform","translate(0, "+n+")"),r=k.selectAll(".leftBot").data([1]).enter().append("g").attr("width",b*e).attr("height",c*j).attr("transform","translate(0, "+o+")"),s=k.selectAll(".midTop").data([1]).enter().append("g").attr("width",b*f).attr("height",c*h).attr("transform","translate("+l+", 0)"),t=k.selectAll(".midMid").data([1]).enter().append("g").attr("width",b*f).attr("height",c*i).attr("transform","translate("+l+", "+n+")"),u=k.selectAll(".midBot").data([1]).enter().append("g").attr("width",b*f).attr("height",c*j).attr("transform","translate("+l+", "+o+")"),v=k.selectAll(".rightTop").data([1]).enter().append("g").attr("width",b*g).attr("height",c*h).attr("transform","translate("+m+", 0)"),w=k.selectAll(".rightMid").data([1]).enter().append("g").attr("width",b*g).attr("height",c*i).attr("transform","translate("+m+", "+n+")"),x=k.selectAll(".rightBot").data([1]).enter().append("g").attr("width",b*g).attr("height",c*j).attr("transform","translate("+m+", "+o+")");return[[p,q,r],[s,t,u],[v,w,x]]}function g(a,b){var c=a.orientation,e=a.drawTarget,f=a.scale,g=a.xShift||0,h=a.yShift||0,i=a.tickSize||6,j=a.axisClass||"refinery-utility-axis",k=a.blank||!1;maxLabelSize=a.maxLabelSize||1/0,k&&(j="refinery-utility-blankaxis");var l=d3.svg.axis().scale(f).orient(c).tickSize(i),m=d3.select(e);m.selectAll("axis").data([1]).enter().append("g").attr("class",j).attr("transform","translate("+g+", "+h+")").style("fill","none").style("stroke",k?"none":"black").call(l),m.selectAll("text").text(function(a){return d(a,maxLabelSize)}),m.selectAll(".tick").on("mousemove",function(a){b.onMouseMove(a,this,b)}).on("mouseover",function(a){b.onMouseOver(a,this,b)}).on("mouseout",function(a){b.onMouseOut(a,this,b)}).on("click",function(a){b.onClick(a,this,b)})}function h(a,b,c,d){for(var h="vertical"===b.orientation?!0:!1,i=.1,j=.8,k=.8,l=b.width*j,m=b.height*k,n=f({width:b.width,height:b.height,drawTarget:b.drawTarget}),o=[],p=0;p<a.items.length;p++)o.push({id:a.items[p],value:a.matrix[p].sum()});var q,r,s=o.map(function(a){return a.value}).max();b.applyLog&&(h?(q=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,l],0),r=d3.scale.log().domain([1,s]).range([m,0])):(q=d3.scale.log().domain([1,s]).range([0,l]),r=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,m],0))),e(o,{globalMax:s,orientation:b.orientation,width:l,height:m,drawTarget:n[1][1][0][0],xScale:q,yScale:r},c);var t,u;b.applyLog?h?(t=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,l],0),u=d3.scale.log().domain([1,s]).range([m,0])):(t=d3.scale.log().domain([1,s]).range([0,l]),u=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,m],0)):h?(t=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,l],0),u=d3.scale.linear().domain([0,s]).range([m,0])):(t=d3.scale.linear().domain([0,s]).range([0,l]),u=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,m],0)),g({orientation:"bottom",drawTarget:n[1][2][0][0],tickSize:h?0:6,scale:t,maxLabelSize:h?l/o.length*.9:1e3},d),g({orientation:"left",drawTarget:n[0][1][0][0],tickSize:h?6:0,scale:u,maxLabelSize:.1*b.width*.9,xShift:i*b.width},d)}function i(a,b,c,d){function h(a){return a.id}var i=0,j="vertical"===b.orientation?!0:!1,k=.8,l=.8,m=f({width:b.width,height:b.height,drawTarget:b.drawTarget}),n=b.width*k,o=b.height*l,p=a.matrix.map(function(a){return a.max()}).max(),q=[];for(i=0;i<a.items.length;i++){for(var r=[],s=0;s<a.matrix[i].length;s++)r.push({id:a.items[i]+"-"+a.categories[s],value:a.matrix[i][s]});q.push(r)}var t=j?.01*n:.01*o,u=j?n/q.length-t:n,v=j?o:o/q.length-t,w=d3.select(m[1][1][0][0]).selectAll("g").data(q).enter().append("g").attr("width",u).attr("height",v).attr("transform",function(a,b){return j?"translate("+b*(u+t)+", 0)":"translate(0, "+b*(v+t)+")"}),x=[];for(i=0;i<w[0].length;i++)x.push({width:u,height:v,orientation:b.orientation,drawTarget:w[0][i],globalMax:p,xScale:y,yScale:z});for(i=0;i<q.length;i++){var y,z;b.applyLog&&(j?(y=d3.scale.ordinal().domain(q[i].map(h)).rangeRoundBands([0,u],0),z=d3.scale.log().domain([1,p]).range([v,0])):(y=d3.scale.log().domain([1,p]).range([0,u]),z=d3.scale.ordinal().domain(q[i].map(h)).rangeRoundBands([0,v],0))),x[i].xScale=y,x[i].yScale=z,e(q[i],x[i],c)}var A,B;b.applyLog?j?(A=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,n],0),B=d3.scale.log().domain([1,p]).range([o,0])):(A=d3.scale.log().domain([1,p]).range([0,u]),B=d3.scale.ordinal().domain(a.items.reverse()).rangeRoundBands([o,0],0)):j?(A=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,n],0),B=d3.scale.linear().domain([0,p]).range([o,0])):(A=d3.scale.linear().domain([0,p]).range([0,u]),B=d3.scale.ordinal().domain(a.items.reverse()).rangeRoundBands([o,0],0)),g({orientation:"bottom",drawTarget:m[1][2][0][0],scale:A,xShift:0,yShift:0,tickSize:j?0:6,maxLabelSize:j?.9*u:1e3},d),g({orientation:"left",drawTarget:m[0][1][0][0],scale:B,xShift:.1*b.width,yShift:0,tickSize:j?6:0,maxLabelSize:.1*b.width*.9},d)}function j(a,d,h,i){function j(){return F[m]}function k(){return F[m]}function l(a){return a.id}var m=0,n="vertical"===d.orientation?!0:!1,o=.1,p=.8,q=.1,r=.1,s=.8,t=.1,u=f({width:d.width,height:d.height,drawTarget:d.drawTarget,hLeft:o,hMid:p,hRight:q,vTop:r,vMid:s,vBot:t}),v=d.width*p,w=d.height*s,x=a.matrix.map(function(a){return a.max()}).max(),y=[];for(m=0;m<a.categories.length;m++){for(var z=[],A=0;A<a.matrix.length;A++)z.push({id:a.items[A]+"-"+a.categories[m],value:a.matrix[A][m]});y.push(z)}var B=n?c("1234567890"):b("W"),C=n?v:v/y.length-B,D=n?w/y.length-B:w,E=d3.select(n?u[1][1][0][0]:u[1][1][0][0]).selectAll("g").data(y).enter().append("g").attr("width",C).attr("height",D).attr("transform",function(a,b){return n?"translate(0, "+b*(D+B)+")":"translate("+b*(C+B)+", 0)"}),F=d3.scale.category10().range(),G=[];for(m=0;m<E[0].length;m++)G.push({width:C,height:D,orientation:d.orientation,drawTarget:E[0][m],globalMax:x,color:j});d3.scale.category10().range().slice(0,y.length).reverse();for(m=0;m<y.length;m++){var H,I;d.applyLog&&(n?(H=d3.scale.ordinal().domain(y[y.length-1-m].map(l)).rangeRoundBands([0,C],0),I=d3.scale.log().domain([1,x]).range([D,0])):(H=d3.scale.log().domain([1,x]).range([0,C]),I=d3.scale.ordinal().domain(y[m].map(l)).rangeRoundBands([0,D],0))),G[m].xScale=H,G[m].yScale=I,n?(G[m].color=k,e(y[y.length-1-m],G[m],h)):e(y[m],G[m],h)}var J,K=d3.scale.log().domain([1,x]).range([0,C]),L=d3.scale.log().domain([1,x]).range([D,0]);if(n)g({orientation:"bottom",drawTarget:u[1][2][0][0],scale:d3.scale.ordinal().domain(a.items).rangeRoundBands([0,C],0),tickSize:0,maxLabelSize:v/y.length*.9,yShift:-c("W")},i);else for(J=d3.select(u[1][2][0][0]).selectAll("g").data(y).enter().append("g").attr("width",C).attr("height",d.height*t).attr("transform",function(a,b){return"translate("+b*(C+B)+", 0)"}),m=0;m<J[0].length;m++)g({orientation:"bottom",drawTarget:J[0][m],scale:d.applyLog?K:d3.scale.linear().domain([0,x]).range([0,C]),tickAmt:3},i);if(n)for(J=d3.select(u[0][1][0][0]).selectAll("g").data(y).enter().append("g").attr("width",d.width*o).attr("height",D).attr("transform",function(a,b){return"translate(0, "+b*(D+B)+")"}),m=0;m<J[0].length;m++)g({orientation:"left",drawTarget:J[0][m],scale:d.applyLog?L:d3.scale.linear().domain([0,x]).range([D,0]),xShift:d.width*o,tickAmt:3},i);else g({orientation:"left",drawTarget:u[0][1][0][0],scale:d3.scale.ordinal().domain(a.items).rangeRoundBands([0,D],0),xShift:d.width*o,tickSize:0,maxLabelSize:d.width*o*.9},i);n?g({orientation:"right",drawTarget:u[2][1][0][0],scale:d3.scale.ordinal().domain(a.categories).rangeRoundBands([w,0],0),blank:!0,maxLabelSize:.1*d.width*.9},i):g({orientation:"bottom",drawTarget:u[1][0][0][0],scale:d3.scale.ordinal().domain(a.categories).rangeRoundBands([0,v],0),blank:!0,maxLabelSize:v/y.length*.9,yShift:.5*(.1*d.height-c("Wgy"))},i)}function k(a,b,c,d){for(var e="vertical"===b.orientation?!0:!1,h=(a.matrix.map(function(a){return a.max()}).max(),a.matrix.map(function(a){return a.sum()}).max()),i=d3.scale.ordinal().domain(a.categories).range(d3.scale.category10().range()),j=f({width:b.width,height:b.height,drawTarget:b.drawTarget}),k=.8*b.width,l=.8*b.height,m=[],n=0;n<a.items.length;n++){m.push({}),m[n].item=a.items[n];for(var o=0;o<a.categories.length;o++)m[n][a.categories[o]]=a.matrix[n][o]}m.forEach(e?function(a){var b=0;a.nums=i.domain().map(function(c){return{name:c,y0:b,y1:b+=+a[c]}}),a.total=a.nums[a.nums.length-1].y1}:function(a){var b=0;a.nums=i.domain().map(function(c){return{name:c,x0:b,x1:b+=a[c]}}),a.total=a.nums[a.nums.length-1].x1});var p,q=e?d3.scale.ordinal().domain(m.map(function(a){return a.item})).rangeRoundBands([0,k],.1):d3.scale.linear().domain([0,d3.max(m,function(a){return a.total})]).range([0,k]),r=e?d3.scale.linear().domain([0,d3.max(m,function(a){return a.total})]).range([l,0]):d3.scale.ordinal().domain(m.map(function(a){return a.item})).rangeRoundBands([0,l],.1);e?(p=d3.select(j[1][1][0][0]).selectAll(".item").data(m).enter().append("g").attr("transform",function(a){return"translate("+q(a.item)+", 0)"}),p.selectAll("rect").data(function(a){return a.nums}).enter().append("rect").attr("class","bar").attr("y",function(a){return r(a.y1)}).attr("width",q.rangeBand()).attr("height",function(a){return r(a.y0)-r(a.y1)}).style("fill",function(a){return i(a.name)}).on("mousemove",function(a){c.onMouseMove({id:a.name,value:a.y1-a.y0},this,c)}).on("mouseover",function(a){c.onMouseOver({id:a.name,value:a.y1-a.y0},this,c)}).on("mouseout",function(a){c.onMouseOut({id:a.name,value:a.y1-a.y0},this,c)}).on("click",function(a){c.onClick({id:a.name,value:a.y1-a.y0},this,c)})):(p=d3.select(j[1][1][0][0]).selectAll(".item").data(m).enter().append("g").attr("transform",function(a){return"translate(0, "+r(a.item)+")"}),p.selectAll("rect").data(function(a){return a.nums.reverse()}).enter().append("rect").attr("class","bar").attr("x",function(a){return q(a.x0)}).attr("y",function(a){return r(a.name)}).attr("width",function(a){return q(a.x1)-q(a.x0)}).attr("height",r.rangeBand()).style("fill",function(a){return i(a.name)}).on("mousemove",function(a){c.onMouseMove({id:a.name,value:a.x1-a.x0},this,c)}).on("mouseover",function(a){c.onMouseOver({id:a.name,value:a.x1-a.x0},this,c)}).on("mouseout",function(a){c.onMouseOut({id:a.name,value:a.x1-a.x0},this,c)}).on("click",function(a){c.onClick({id:a.name,value:a.x1-a.x0},this,c)})),g({orientation:"bottom",drawTarget:j[1][2][0][0],scale:e?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,k],0):d3.scale.linear().domain([0,h]).range([0,k]),tickSize:e?0:6,maxLabelSize:e?k/m.length*.9:1e3},d),g({orientation:"left",drawTarget:j[0][1][0][0],scale:e?d3.scale.linear().domain([0,h]).range([l,0]):d3.scale.ordinal().domain(a.items).rangeRoundBands([0,l],0),xShift:.1*b.width,tickSize:e?6:0,maxLabelSize:.1*b.width*.9},d)}function l(a,b,c){d3.select("#"+b.drawTarget).html("");var d=jQuery.extend(!0,{},c),e=jQuery.extend(!0,{},b),f=jQuery.extend(!0,{},o),g=jQuery.extend(!0,{},p);"group"===a?i(d,e,f,g):"layer"===a?j(d,e,f,g):"simple"===a?h(d,e,f,g):"stack"===a?k(d,e,f,g):alert("Invalid chart type"),d3.select("#"+b.drawTarget).selectAll("text").attr("font-family","times new roman").attr("font-size","14px").attr("fill","black").attr("stroke","none")}Array.prototype.max=function(){for(var a=0,b=this.length;b--;)a<this[b]&&(a=this[b]);return a},Array.prototype.sum=function(){for(var a=0,b=this.length;b--;)a+=this[b];return a};var m=d3.select("body").append("div").attr("class","refinery-utility-barTooltip").style("opacity",0).style("position","absolute").style("text-align","center").attr("width","100px").style("background-color","#000").style("opacity","0.8").style("color","#fff").style("font-weight","normal").style("font-size","11.9px").style("border-radius","3px").style("padding","1px 4px 1px 4px"),n=d3.select("body").append("div").attr("class","refinery-utility-labelTooltip").style("opacity",0).style("position","absolute").style("text-align","center").attr("width","100px").style("background-color","#000").style("opacity","0.8").style("color","#fff").style("font-weight","normal").style("font-size","11.9px").style("border-radius","3px").style("padding","1px 4px 1px 4px"),o={onMouseMove:function(a,b,c){c.barTooltipFlag&&c.barTooltip.html(a.id+"<br>"+a.value).style("opacity",.9).style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")},onMouseOver:function(a,b,c){c.barTooltipFlag=!0,d3.select(b.parentNode).selectAll(".bar").attr("opacity",.6),d3.select(b).attr("opacity",1)},onMouseOut:function(a,b,c){c.barTooltipFlag=!1,d3.select(b.parentNode).selectAll(".bar").attr("opacity",1),c.barTooltip.style("opacity",0)},onClick:function(){console.log("clicky bar action going on")},barTooltip:m,barTooltipFlag:!1},p={onMouseMove:function(a){p.labelTooltipFlag&&n.html(a).style("opacity",.9).style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")},onMouseOver:function(){p.labelTooltipFlag=!0},onMouseOut:function(){p.labelTooltip=!1,n.style("opacity",0)},onClick:function(){console.log("clicky label action going on")},lableTooltip:n,labelTooltipFlag:!1},q={draw:l};return q}()}};