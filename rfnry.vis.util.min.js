/*! refinery-utility-visualization 2014-07-02 */
var rfnry={vis:{util:function(){function a(a){d3.selectAll("#test").remove();var b=d3.select("body").append("svg").attr("id","test").attr("width",0).attr("height",0).selectAll("text").data([1]).enter().append("text").text(a);return b[0][0].getBBox()}function b(b){return a(b).width}function c(b){return a(b).height}function d(a,c){if(b(a)<=c)return a;for(var d=0;d<a.length/2;d++){var e=a.substring(0,a.length/2-d)+".."+a.substring(a.length/2+d,a.length);if(b(e)<=c)return e}}function e(a,b,c){var d=a[b];a[b]=a[c],a[c]=d}function f(a,b,c){var d="vertical"===b.orientation?!0:!1,e=b.width,f=b.height,g=b.globalMax,h=b.color||d3.scale.category10().domain(a.map(function(a){return a.id})),i=b.barPadding||d?.01*e:.01*f,j=b.barThickness||(d?e:f)/a.length-i,k=b.xScale||(d?d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,e],.05):d3.scale.linear().domain([0,g]).range([0,e])),l=b.yScale||(d?d3.scale.linear().domain([0,g]).range([f,0]):d3.scale.ordinal().domain(a.map(function(a){return a.id})).rangeRoundBands([0,f],.05));d3.select(b.drawTarget).selectAll("rect").data(a).enter().append("rect").attr("class","bar").attr("x",function(a){return d?k(a.id):0}).attr("y",function(a){return l(d?a.value:a.id)}).attr("width",function(a){return d?j:k(a.value)}).attr("height",function(a){return d?f-l(a.value):j}).style("fill",function(a){return h(a.id)}).on("mousemove",function(a){c.onMouseMove(a,this,c,b.barCallbacks)}).on("mouseover",function(a){c.onMouseOver(a,this,c,b.barCallbacks)}).on("mouseout",function(a){c.onMouseOut(a,this,c,b.barCallbacks)}).on("click",function(a){c.onClick(a,this,c,b.barCallbacks)})}function g(a){var b=a.width,c=a.height,d=a.drawTarget,e=a.hLeft||.1,f=a.hMid||.8,g=a.hRight||.1,h=a.vTop||.1,i=a.vMid||.8,j=a.vBot||.1;d3.select("#"+d).html("");var k=d3.select("#"+d).append("svg").attr("width",b).attr("height",c),l=b*e,m=b*(e+f),n=c*h,o=c*(h+i),p=k.selectAll(".leftTop").data([1]).enter().append("g").attr("width",b*e).attr("height",c*h).attr("transform","translate(0, 0)"),q=k.selectAll(".leftMid").data([1]).enter().append("g").attr("width",b*e).attr("height",c*i).attr("transform","translate(0, "+n+")"),r=k.selectAll(".leftBot").data([1]).enter().append("g").attr("width",b*e).attr("height",c*j).attr("transform","translate(0, "+o+")"),s=k.selectAll(".midTop").data([1]).enter().append("g").attr("width",b*f).attr("height",c*h).attr("transform","translate("+l+", 0)"),t=k.selectAll(".midMid").data([1]).enter().append("g").attr("width",b*f).attr("height",c*i).attr("transform","translate("+l+", "+n+")"),u=k.selectAll(".midBot").data([1]).enter().append("g").attr("width",b*f).attr("height",c*j).attr("transform","translate("+l+", "+o+")"),v=k.selectAll(".rightTop").data([1]).enter().append("g").attr("width",b*g).attr("height",c*h).attr("transform","translate("+m+", 0)"),w=k.selectAll(".rightMid").data([1]).enter().append("g").attr("width",b*g).attr("height",c*i).attr("transform","translate("+m+", "+n+")"),x=k.selectAll(".rightBot").data([1]).enter().append("g").attr("width",b*g).attr("height",c*j).attr("transform","translate("+m+", "+o+")");return[[p,q,r],[s,t,u],[v,w,x]]}function h(a,b){var c=a.orientation,e=a.drawTarget,f=a.scale,g=a.xShift||0,h=a.yShift||0,i=a.tickSize||6,j=a.axisClass||"refinery-utility-axis",k=a.blank||!1;maxLabelSize=a.maxLabelSize||1/0,k&&(j="refinery-utility-blankaxis");var l=d3.svg.axis().scale(f).orient(c).tickSize(i),m=d3.select(e);m.selectAll("axis").data([1]).enter().append("g").attr("class",j).attr("transform","translate("+g+", "+h+")").style("fill","none").style("stroke",k?"none":"black").style("cursor","default").call(l),m.selectAll("text").text(function(a){return d(a,maxLabelSize)}),m.selectAll(".tick").on("mousemove",function(c){b.onMouseMove(c,this,b,a.labelCallbacks)}).on("mouseover",function(c){b.onMouseOver(c,this,b,a.labelCallbacks)}).on("mouseout",function(c){b.onMouseOut(c,this,b,a.labelCallbacks)}).on("click",function(c){b.onClick(c,this,b,a.labelCallbacks)})}function i(a,b,c,d){function e(a){return a.id}for(var i="vertical"===b.orientation?!0:!1,j=b.color||d3.scale.category10().range(),k=.1,l=.8,m=.8,n=b.width*l,o=b.height*m,p=g({width:b.width,height:b.height,drawTarget:b.drawTarget}),q=[],r=0;r<a.items.length;r++)q.push({id:a.items[r],value:a.matrix[r].sum()});var s,t,u=q.map(function(a){return a.value}).max();b.applyLog&&(i?(s=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,n],0),t=d3.scale.log().domain([1,u]).range([o,0])):(s=d3.scale.log().domain([1,u]).range([0,n]),t=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,o],0))),f(q,{globalMax:u,orientation:b.orientation,width:n,height:o,drawTarget:p[1][1][0][0],xScale:s,yScale:t,color:d3.scale.ordinal().domain(q.map(e)).range(j),barCallbacks:b.barCallbacks},c);var v,w;b.applyLog?i?(v=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,n],.05),w=d3.scale.log().domain([1,u]).range([o,0])):(v=d3.scale.log().domain([1,u]).range([0,n]),w=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,o],.05)):i?(v=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,n],.05),w=d3.scale.linear().domain([0,u]).range([o,0])):(v=d3.scale.linear().domain([0,u]).range([0,n]),w=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,o],.05)),h({orientation:"bottom",drawTarget:p[1][2][0][0],tickSize:i?0:6,scale:v,maxLabelSize:i?n/q.length*.9:1e3,labelCallbacks:b.labelCallbacks},d),h({orientation:"left",drawTarget:p[0][1][0][0],tickSize:i?6:0,scale:w,maxLabelSize:.1*b.width*.9,xShift:k*b.width,labelCallbacks:b.labelCallbacks},d)}function j(a,b,c,d){function e(a){return a.id}var i=0,j="vertical"===b.orientation?!0:!1,k=b.color||d3.scale.category10().range(),l=.8,m=.8,n=g({width:b.width,height:b.height,drawTarget:b.drawTarget}),o=b.width*l,p=b.height*m,q=a.matrix.map(function(a){return a.max()}).max(),r=[];for(i=0;i<a.items.length;i++){for(var s=[],t=0;t<a.matrix[i].length;t++)s.push({id:a.items[i]+"-"+a.categories[t],value:a.matrix[i][t]});r.push(s)}var u=j?.01*o:.01*p,v=j?o/r.length-u:o,w=j?p:p/r.length-u,x=d3.select(n[1][1][0][0]).selectAll("g").data(r).enter().append("g").attr("width",v).attr("height",w).attr("transform",function(a,b){return j?"translate("+b*(v+u)+", 0)":"translate(0, "+b*(w+u)+")"}),y=[];for(i=0;i<x[0].length;i++)y.push({width:v,height:w,orientation:b.orientation,drawTarget:x[0][i],globalMax:q,xScale:z,yScale:A,color:d3.scale.ordinal().domain(r[i].map(e)).range(k),barCallbacks:b.barCallbacks});for(i=0;i<r.length;i++){var z,A;b.applyLog&&(j?(z=d3.scale.ordinal().domain(r[i].map(e)).rangeRoundBands([0,v],0),A=d3.scale.log().domain([1,q]).range([w,0])):(z=d3.scale.log().domain([1,q]).range([0,v]),A=d3.scale.ordinal().domain(r[i].map(e)).rangeRoundBands([0,w],0))),y[i].xScale=z,y[i].yScale=A,f(r[i],y[i],c)}var B,C;b.applyLog?j?(B=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,o],0),C=d3.scale.log().domain([1,q]).range([p,0])):(B=d3.scale.log().domain([1,q]).range([0,v]),C=d3.scale.ordinal().domain(a.items.reverse()).rangeRoundBands([p,0],0)):j?(B=d3.scale.ordinal().domain(a.items).rangeRoundBands([0,o],0),C=d3.scale.linear().domain([0,q]).range([p,0])):(B=d3.scale.linear().domain([0,q]).range([0,v]),C=d3.scale.ordinal().domain(a.items.reverse()).rangeRoundBands([p,0],0)),h({orientation:"bottom",drawTarget:n[1][2][0][0],scale:B,xShift:0,yShift:0,tickSize:j?0:6,maxLabelSize:j?.9*v:1e3,labelCallbacks:b.labelCallbacks},d),h({orientation:"left",drawTarget:n[0][1][0][0],scale:C,xShift:.1*b.width,yShift:0,tickSize:j?6:0,maxLabelSize:.1*b.width*.9,labelCallbacks:b.labelCallbacks},d)}function k(a,d,e,i){function j(){return o[m]}function k(){return H[m]}function l(a){return a.id}var m=0,n="vertical"===d.orientation?!0:!1,o=d.color||d3.scale.category10().range(),p=.1,q=.8,r=.1,s=.1,t=.8,u=.1,v=g({width:d.width,height:d.height,drawTarget:d.drawTarget,hLeft:p,hMid:q,hRight:r,vTop:s,vMid:t,vBot:u}),w=d.width*q,x=d.height*t,y=a.matrix.map(function(a){return a.max()}).max(),z=[];for(m=0;m<a.categories.length;m++){for(var A=[],B=0;B<a.matrix.length;B++)A.push({id:a.items[B]+"-"+a.categories[m],value:a.matrix[B][m]});z.push(A)}var C=n?c("1234567890"):b("W"),D=n?w:w/z.length-C,E=n?x/z.length-C:x,F=d3.select(n?v[1][1][0][0]:v[1][1][0][0]).selectAll("g").data(z).enter().append("g").attr("width",D).attr("height",E).attr("transform",function(a,b){return n?"translate(0, "+b*(E+C)+")":"translate("+b*(D+C)+", 0)"}),G=[];for(m=0;m<F[0].length;m++)G.push({width:D,height:E,orientation:d.orientation,drawTarget:F[0][m],globalMax:y,color:j,barCallbacks:d.barCallbacks});var H=o.slice(0,z.length).reverse();for(m=0;m<z.length;m++){var I,J;d.applyLog&&(n?(I=d3.scale.ordinal().domain(z[z.length-1-m].map(l)).rangeRoundBands([0,D],0),J=d3.scale.log().domain([1,y]).range([E,0])):(I=d3.scale.log().domain([1,y]).range([0,D]),J=d3.scale.ordinal().domain(z[m].map(l)).rangeRoundBands([0,E],0))),G[m].xScale=I,G[m].yScale=J,n?(G[m].color=k,f(z[z.length-1-m],G[m],e)):f(z[m],G[m],e)}var K,L=d3.scale.log().domain([1,y]).range([0,D]),M=d3.scale.log().domain([1,y]).range([E,0]);if(n)h({orientation:"bottom",drawTarget:v[1][2][0][0],scale:d3.scale.ordinal().domain(a.items).rangeRoundBands([0,D],0),tickSize:0,maxLabelSize:w/z.length*.9,yShift:-c("W"),labelCallbacks:d.labelCallbacks},i);else for(K=d3.select(v[1][2][0][0]).selectAll("g").data(z).enter().append("g").attr("width",D).attr("height",d.height*u).attr("transform",function(a,b){return"translate("+b*(D+C)+", 0)"}),m=0;m<K[0].length;m++)h({orientation:"bottom",drawTarget:K[0][m],scale:d.applyLog?L:d3.scale.linear().domain([0,y]).range([0,D]),tickAmt:3,labelCallbacks:d.labelCallbacks},i);if(n)for(K=d3.select(v[0][1][0][0]).selectAll("g").data(z).enter().append("g").attr("width",d.width*p).attr("height",E).attr("transform",function(a,b){return"translate(0, "+b*(E+C)+")"}),m=0;m<K[0].length;m++)h({orientation:"left",drawTarget:K[0][m],scale:d.applyLog?M:d3.scale.linear().domain([0,y]).range([E,0]),xShift:d.width*p,tickAmt:3,labelCallbacks:d.labelCallbacks},i);else h({orientation:"left",drawTarget:v[0][1][0][0],scale:d3.scale.ordinal().domain(a.items).rangeRoundBands([0,E],0),xShift:d.width*p,tickSize:0,maxLabelSize:d.width*p*.9,labelCallbacks:d.labelCallbacks},i);n?h({orientation:"right",drawTarget:v[2][1][0][0],scale:d3.scale.ordinal().domain(a.categories).rangeRoundBands([x,0],0),blank:!0,maxLabelSize:.1*d.width*.9,labelCallbacks:d.labelCallbacks},i):h({orientation:"bottom",drawTarget:v[1][0][0][0],scale:d3.scale.ordinal().domain(a.categories).rangeRoundBands([0,w],0),blank:!0,maxLabelSize:w/z.length*.9,yShift:.5*(.1*d.height-c("Wgy")),labelCallbacks:d.labelCallbacks},i)}function l(a,b,c,d){for(var e="vertical"===b.orientation?!0:!1,f=(a.matrix.map(function(a){return a.max()}).max(),a.matrix.map(function(a){return a.sum()}).max()),i=b.color||d3.scale.category10().range(),j=d3.scale.ordinal().domain(a.categories).range(i),k=g({width:b.width,height:b.height,drawTarget:b.drawTarget}),l=.8*b.width,m=.8*b.height,n=[],o=0;o<a.items.length;o++){n.push({}),n[o].item=a.items[o];for(var p=0;p<a.categories.length;p++)n[o][a.categories[p]]=a.matrix[o][p]}n.forEach(e?function(a){var b=0;a.nums=j.domain().map(function(c){return{name:c,y0:b,y1:b+=+a[c]}}),a.total=a.nums[a.nums.length-1].y1}:function(a){var b=0;a.nums=j.domain().map(function(c){return{name:c,x0:b,x1:b+=a[c]}}),a.total=a.nums[a.nums.length-1].x1});var q,r=e?d3.scale.ordinal().domain(n.map(function(a){return a.item})).rangeRoundBands([0,l],.05):d3.scale.linear().domain([0,d3.max(n,function(a){return a.total})]).range([0,l]),s=e?d3.scale.linear().domain([0,d3.max(n,function(a){return a.total})]).range([m,0]):d3.scale.ordinal().domain(n.map(function(a){return a.item})).rangeRoundBands([0,m],.05);e?(q=d3.select(k[1][1][0][0]).selectAll(".item").data(n).enter().append("g").attr("transform",function(a){return"translate("+r(a.item)+", 0)"}),q.selectAll("rect").data(function(a){return a.nums}).enter().append("rect").attr("class","bar").attr("y",function(a){return s(a.y1)}).attr("width",r.rangeBand()).attr("height",function(a){return s(a.y0)-s(a.y1)}).style("fill",function(a){return j(a.name)}).on("mousemove",function(a){c.onMouseMove({id:a.name,value:a.y1-a.y0},this,c,b.barCallbacks)}).on("mouseover",function(a){c.onMouseOver({id:a.name,value:a.y1-a.y0},this,c,b.barCallbacks)}).on("mouseout",function(a){c.onMouseOut({id:a.name,value:a.y1-a.y0},this,c,b.barCallbacks)}).on("click",function(a){c.onClick({id:a.name,value:a.y1-a.y0},this,c,b.barCallbacks)})):(q=d3.select(k[1][1][0][0]).selectAll(".item").data(n).enter().append("g").attr("transform",function(a){return"translate(0, "+s(a.item)+")"}),q.selectAll("rect").data(function(a){return a.nums.reverse()}).enter().append("rect").attr("class","bar").attr("x",function(a){return r(a.x0)}).attr("y",function(a){return s(a.name)}).attr("width",function(a){return r(a.x1)-r(a.x0)}).attr("height",s.rangeBand()).style("fill",function(a){return j(a.name)}).on("mousemove",function(a){c.onMouseMove({id:a.name,value:a.x1-a.x0},this,c,b.barCallbacks)}).on("mouseover",function(a){c.onMouseOver({id:a.name,value:a.x1-a.x0},this,c,b.barCallbacks)}).on("mouseout",function(a){c.onMouseOut({id:a.name,value:a.x1-a.x0},this,c,b.barCallbacks)}).on("click",function(a){c.onClick({id:a.name,value:a.x1-a.x0},this,c,b.barCallbacks)})),h({orientation:"bottom",drawTarget:k[1][2][0][0],scale:e?d3.scale.ordinal().domain(a.items).rangeRoundBands([0,l],.05):d3.scale.linear().domain([0,f]).range([0,l]),tickSize:e?0:6,maxLabelSize:e?l/n.length*.9:1e3,labelCallbacks:b.labelCallbacks},d),h({orientation:"left",drawTarget:k[0][1][0][0],scale:e?d3.scale.linear().domain([0,f]).range([m,0]):d3.scale.ordinal().domain(a.items).rangeRoundBands([0,m],.05),xShift:.1*b.width,tickSize:e?6:0,maxLabelSize:.1*b.width*.9,labelCallbacks:b.labelCallbacks},d)}function m(a,b,c){var d,f;d3.select("#"+b.drawTarget).html("");var g=!1;if(c.matrix.map(function(a){a.map(function(a){0>a&&(alert("Error: data set contains negative values"),g=!0)})}),!g){var h=jQuery.extend(!0,{},c),m=jQuery.extend(!0,{},b),n=jQuery.extend(!0,{},p),o=jQuery.extend(!0,{},q),r=[];for(d=0;d<c.items.length;d++)r.push({id:c.items[d],value:c.matrix[d].sum()});for(d=0;d<r.length;d++)for(f=0;f<r.length-d-1;f++)("sum"===b.sort?r[f].value<r[f+1].value:"label"===b.sort?r[f].id>r[f+1].id:!1)&&(e(r,f,f+1),e(h.items,f,f+1),e(h.matrix,f,f+1),e(m.color,f,f+1));"group"===a?j(h,m,n,o):"layer"===a?k(h,m,n,o):"simple"===a?i(h,m,n,o):"stack"===a?l(h,m,n,o):alert("Invalid chart type"),d3.select("#"+b.drawTarget).selectAll("text").attr("font-family","times new roman").attr("font-size","14px").attr("fill","black").attr("stroke","none")}}Array.prototype.max=function(){for(var a=0,b=this.length;b--;)a<this[b]&&(a=this[b]);return a},Array.prototype.sum=function(){for(var a=0,b=this.length;b--;)a+=this[b];return a};var n=d3.select("body").append("div").attr("class","refinery-utility-barTooltip").style("opacity",0).style("position","absolute").style("text-align","center").attr("width","100px").style("background-color","#000").style("opacity","0.8").style("color","#fff").style("font-weight","normal").style("font-size","11.9px").style("border-radius","3px").style("padding","1px 4px 1px 4px"),o=d3.select("body").append("div").attr("class","refinery-utility-labelTooltip").style("opacity",0).style("position","absolute").style("text-align","center").attr("width","100px").style("background-color","#000").style("opacity","0.8").style("color","#fff").style("font-weight","normal").style("font-size","11.9px").style("border-radius","3px").style("padding","1px 4px 1px 4px"),p={onMouseMove:function(a,b,c,d){c.barTooltipFlag&&c.barTooltip.html(a.id+"<br>"+a.value).style("opacity",.9).style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px"),d&&d.onMouseMove&&d.onMouseMove()},onMouseOver:function(a,b,c,d){c.barTooltipFlag=!0,d3.select(b.parentNode).selectAll(".bar").attr("opacity",.6),d3.select(b).attr("opacity",1),d&&d.onMouseOver&&d.onMouseOver()},onMouseOut:function(a,b,c,d){c.barTooltipFlag=!1,d3.select(b.parentNode).selectAll(".bar").attr("opacity",1),c.barTooltip.style("opacity",0),d&&d.onMouseOut&&d.onMouseOut()},onClick:function(a,b,c,d){console.log("clicky bar action going on"),d&&d.onClick&&d.onClick()},barTooltip:n,barTooltipFlag:!1},q={onMouseMove:function(a,b,c,d){c.labelTooltipFlag&&o.html(a).style("opacity",.9).style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px"),d&&d.onMouseMove&&d.onMouseMove()},onMouseOver:function(a,b,c,d){c.labelTooltipFlag=!0,d&&d.onMouseOver&&d.onMouseOver()},onMouseOut:function(a,b,c,d){c.labelTooltip=!1,o.style("opacity",0),d&&d.onMouseOut&&d.onMouseOut()},onClick:function(a,b,c,d){console.log("clicky label action going on"),d&&d.onClick&&d.onClick()},lableTooltip:o,labelTooltipFlag:!1},r={draw:m};return r}()}};